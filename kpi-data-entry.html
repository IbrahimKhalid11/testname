<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KPI Data Entry - Performance Tracking</title>
    <link rel="icon" type="image/svg+xml" href="assets/images/favicon.svg">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/style.css">
    <style>
        .data-entry-container {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .compact-panel {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            max-height: 600px;
            overflow-y: auto;
        }
        
        .compact-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .compact-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary-color);
            margin: 0;
        }
        
        .scorecard-panel {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .scorecard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .scorecard-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--primary-color);
            margin: 0;
        }
        
        .scorecard-period {
            background: var(--secondary-color);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .kpi-entry-form {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .kpi-entry-item {
            display: grid;
            grid-template-columns: 1fr auto auto auto;
            gap: 10px;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 6px;
            margin-bottom: 8px;
            border: 1px solid #e9ecef;
        }
        
        .kpi-input {
            width: 80px;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
            font-size: 0.85rem;
        }
        
        .kpi-entry-item {
            display: grid;
            grid-template-columns: 1fr auto auto auto;
            gap: 15px;
            align-items: center;
            padding: 15px;
            background: white;
            border-radius: 6px;
            margin-bottom: 10px;
            border: 1px solid #e9ecef;
        }
        
        .kpi-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .kpi-name {
            font-weight: 600;
            color: #333;
        }
        
        .kpi-details {
            font-size: 0.85rem;
            color: #666;
        }
        
        .kpi-target {
            text-align: center;
            font-weight: 500;
            color: #007bff;
        }
        
        .kpi-input {
            width: 100px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
            font-size: 0.9rem;
        }
        
        .kpi-performance {
            text-align: center;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85rem;
        }
        
        .performance-excellent {
            background: #d4edda;
            color: #155724;
        }
        
        .performance-good {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .performance-warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .performance-poor {
            background: #f8d7da;
            color: #721c24;
        }
        
        .performance-unknown {
            background: #f8f9fa;
            color: #6c757d;
        }
        
        /* Pagination Styles */
        .pagination-controls {
            border-top: 1px solid #e0e0e0;
        }
        
        .pagination-controls .action-button.small {
            padding: 6px 12px;
            font-size: 0.85rem;
            border: 1px solid #ddd;
            background: white;
            color: #333;
            transition: all 0.2s ease;
        }
        
        .pagination-controls .action-button.small:hover:not(:disabled) {
            background: #f8f9fa;
            border-color: #007bff;
        }
        
        .pagination-controls .action-button.small:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .page-numbers button {
            margin: 0 2px;
        }
        
        .pagination-info {
            font-weight: 500;
            color: #666;
        }
        
        .pagination-size select {
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.85rem;
        }
        
        .results-panel {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .results-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--primary-color);
            margin: 0;
        }
        
        .score-display {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .score-number {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .score-label {
            font-size: 1rem;
            opacity: 0.9;
        }
        
        .performance-breakdown {
            margin-bottom: 20px;
        }
        
        .breakdown-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .breakdown-item:last-child {
            border-bottom: none;
        }
        
        .breakdown-label {
            font-weight: 500;
            color: #333;
        }
        
        .breakdown-value {
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .history-chart {
            height: 200px;
            background: #f8f9fa;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-style: italic;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn-save {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .btn-save:hover {
            background: #0056b3;
        }
        
        .btn-reset {
            background: #6c757d;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .btn-reset:hover {
            background: #5a6268;
        }
        
        .btn-submit {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .btn-submit:hover {
            background-color: #218838;
        }
        
        .btn-approve {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
            display: none;
        }
        
        .btn-approve:hover {
            background-color: #0056b3;
        }
        
        .btn-history {
            background: var(--secondary-color);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .btn-history:hover {
            background: #28a745;
        }
        
        .filter-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .filter-group label {
            font-size: 0.8rem;
            font-weight: 500;
            color: #333;
        }
        
        .filter-group select,
        .filter-group input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .empty-state i {
            font-size: 3rem;
            color: #ddd;
            margin-bottom: 20px;
        }
        
        .period-selector {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .period-selector select,
        .period-selector input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .period-selector label {
            font-weight: 500;
            color: #333;
        }
        
        .btn-history-report {
            background: var(--secondary-color);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .btn-history-report:hover {
            background: #28a745;
        }
        
        .btn-history-report:disabled {
            background: #6c757d;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .auto-save-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            color: #666;
            margin-top: 10px;
        }
        
        .auto-save-indicator.saving {
            color: #007bff;
        }
        
        .auto-save-indicator.saved {
            color: #28a745;
        }
        
        .auto-save-indicator.error {
            color: #dc3545;
        }
        
        .action-icon {
            background: none;
            border: none;
            padding: 4px 6px;
            margin: 0 2px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .action-icon.view {
            color: #007bff;
        }
        
        .action-icon.view:hover {
            background-color: #e3f2fd;
        }
        
        .action-icon.preview {
            color: #28a745;
        }
        
        .action-icon.preview:hover {
            background-color: #e8f5e8;
        }
        
        .action-icon.add {
            color: #ffc107;
        }
        
        .action-icon.add:hover {
            background-color: #fff8e1;
        }
        
        .performance-summary-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-bottom: 15px;
            padding: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            color: white;
        }
        
        .summary-item {
            text-align: center;
            padding: 8px;
        }
        
        .summary-value {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 2px;
        }
        
        .summary-label {
            font-size: 0.75rem;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-display {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            display: none;
        }
        
        .status-info {
            font-size: 0.9rem;
            color: #666;
        }
        
        .approval-info {
            margin-top: 5px;
            font-size: 0.9rem;
            color: #666;
        }
        
        /* History Report Styles */
        .history-report-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .history-report-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .history-report-subtitle {
            font-size: 1rem;
            opacity: 0.9;
        }
        
        .history-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .history-stat-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .history-stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .history-stat-label {
            font-size: 0.9rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .history-timeline {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .timeline-item {
            display: flex;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .timeline-item:last-child {
            border-bottom: none;
        }
        
        .timeline-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 1.2rem;
        }
        
        .timeline-icon.draft {
            background: #6c757d;
            color: white;
        }
        
        .timeline-icon.submitted {
            background: #ffc107;
            color: #333;
        }
        
        .timeline-icon.approved {
            background: #28a745;
            color: white;
        }
        
        .timeline-content {
            flex: 1;
        }
        
        .timeline-period {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }
        
        .timeline-status {
            font-size: 0.9rem;
            color: #666;
        }
        
        .timeline-score {
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .performance-chart {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .chart-container {
            height: 300px;
            position: relative;
            margin-top: 15px;
            display: flex;
            align-items: end;
            gap: 10px;
            padding: 20px 0;
        }
        
        .chart-bar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 4px 4px 0 0;
            transition: height 0.3s ease;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
            min-width: 40px;
            flex: 1;
        }
        
        .chart-label {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.8rem;
            color: #666;
            font-weight: 500;
            white-space: nowrap;
        }
        
        .kpi-breakdown {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .kpi-breakdown-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .kpi-breakdown-item {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 15px;
            border-left: 4px solid var(--primary-color);
        }
        
        .kpi-breakdown-name {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }
        
        .kpi-breakdown-stats {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: #666;
        }
        
        .export-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }
        
        .export-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }
        
        .export-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .export-btn:hover {
            background: #0056b3;
        }
        
        .export-btn.pdf {
            background: #dc3545;
        }
        
        .export-btn.pdf:hover {
            background: #c82333;
        }
        
        .export-btn.excel {
            background: #28a745;
        }
        
        .export-btn.excel:hover {
            background: #218838;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar Toggle Button -->
        <button class="sidebar-toggle" id="sidebar-toggle" onclick="toggleSidebar()">
            <i class="fas fa-bars"></i>
        </button>
        
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-chart-line"></i>
                <h2>KPI System</h2>
            </div>
            <nav class="sidebar-nav">
                <ul>
                    <li><a href="index.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                    <li><a href="reports.html"><i class="fas fa-file-alt"></i> Reports</a></li>
                    <li class="active"><a href="kpi-data-entry.html"><i class="fas fa-chart-bar"></i> KPI Data Entry</a></li>
                    <li><a href="scorecard-designer.html"><i class="fas fa-edit"></i> Scorecard Designer</a></li>
                    <li><a href="system-reports.html"><i class="fas fa-chart-line"></i> System Reports</a></li>
                    <li><a href="calendar.html"><i class="fas fa-calendar-alt"></i> Calendar</a></li>
                    <li><a href="users.html"><i class="fas fa-users"></i> User Management</a></li>
                    <li><a href="settings.html"><i class="fas fa-cog"></i> Settings</a></li>
                </ul>
            </nav>
            <div class="sidebar-footer">
                <a href="login.html" class="logout-btn">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </div>
        </aside>
        
        <main class="main-content" id="main-content">
            <header class="main-header">
                <h1><i class="fas fa-chart-bar"></i> KPI Data Entry & Results Tracking</h1>
                <p>Enter actual KPI values and track performance against targets</p>
            </header>
            
            <section class="content-section">
                <!-- Filter Bar -->
                <div class="filter-bar">
                    <div class="filter-group">
                        <label for="scorecard-filter">Scorecard</label>
                        <select id="scorecard-filter" disabled>
                            <option value="">Select Scorecard</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="department-filter">Department</label>
                        <select id="department-filter">
                            <option value="">All Departments</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="status-filter">Status</label>
                        <select id="status-filter">
                            <option value="">All Status</option>
                            <option value="draft">Draft</option>
                            <option value="submitted">Submitted</option>
                            <option value="approved">Approved</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <button id="monthly-list-btn" class="action-button" disabled>
                            <i class="fas fa-list"></i> Monthly List
                    </button>
                    </div>
                </div>
                
                <!-- Main Content Grid -->
                <div class="data-entry-container">
                    <!-- History Report Panel (Left Column) -->
                    <div class="compact-panel">
                        <div class="compact-header">
                            <h3 class="compact-title" id="inline-history-title">Scorecard History Report</h3>
                        </div>
                        
                        <div class="content-area">
                            <!-- Filter Controls for History -->
                            <div class="history-filters" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                                <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                                    <div class="filter-group">
                                        <label for="inline-history-period-filter" style="font-weight: 500; margin-bottom: 5px; display: block;">Period Type:</label>
                                        <select id="inline-history-period-filter" onchange="updateInlineHistoryFilters()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px;">
                                            <option value="month">Monthly</option>
                                            <option value="quarter">Quarterly</option>
                                            <option value="season">Seasonal</option>
                                            <option value="year">Yearly</option>
                                        </select>
                            </div>
                                    <div class="filter-group">
                                        <label for="inline-history-year-filter" style="font-weight: 500; margin-bottom: 5px; display: block;">Year:</label>
                                        <select id="inline-history-year-filter" onchange="updateInlineHistoryFilters()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px;">
                                            <option value="all">All Years</option>
                                        </select>
                        </div>
                                    <div class="filter-group">
                                        <button onclick="applyInlineHistoryFilters()" style="background: var(--primary-color); color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                                            <i class="fas fa-filter"></i> Apply Filters
                                </button>
                            </div>
                        </div>
                    </div>
                    
                            <div id="inline-history-content">
                                <!-- History content will be loaded here -->
                                <div class="empty-state">
                                    <i class="fas fa-chart-line"></i>
                                    <h3>No Scorecard Selected</h3>
                                    <p>Select a scorecard from the dropdown above to view history report</p>
                        </div>
                            </div>
                        </div>
                            </div>
                            
                    <!-- Related Reports Panel (Right Column) -->
                    <div class="compact-panel">
                        <div class="compact-header">
                            <h3 class="compact-title">Related Reports</h3>
                                </div>
                        <div class="content-area">
                            <!-- Preview Pane for Reports -->
                            <div class="report-preview-pane" style="margin-bottom: 20px; padding: 20px; background-color: #f9f9f9; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                                <div class="preview-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                    <h3 id="preview-title">Report Preview</h3>
                                    <div>
                                        <span id="preview-info" style="font-size: 0.9rem; color: #666;"></span>
                                </div>
                                </div>
                                <div class="preview-content" style="display: flex; flex-direction: column; align-items: center;">
                                    <div id="preview-container" style="width: 100%; aspect-ratio: 5/3; display: flex; justify-content: center; align-items: center; overflow: hidden; border: 1px solid #ddd; border-radius: 8px; background: #f9f9f9;">
                                        <p id="no-preview-message" style="color: #999; font-style: italic;">Select a report to preview</p>
                                        <img id="preview-image" src="" alt="Report Preview" style="max-width: 100%; max-height: 400px; display: none;">
                                </div>
                                    <div class="preview-controls" style="display: flex; justify-content: center; align-items: center; margin-top: 15px;">
                                        <button id="prev-report-btn" class="action-button secondary" style="margin-right: 10px;" disabled>
                                            <i class="fas fa-chevron-left"></i> Previous
                                </button>
                                        <span id="preview-counter" style="margin: 0 15px;">0 of 0</span>
                                        <button id="next-report-btn" class="action-button secondary" style="margin-left: 10px;" disabled>
                                            Next <i class="fas fa-chevron-right"></i>
                                </button>
                                    </div>
                                </div>
                            </div>
                            <div class="table-container" style="margin-top: 15px;">
                                <table class="data-table" id="related-reports-table">
                                    <thead>
                                        <tr>
                                            <th>Report Type</th>
                                            <th>Department</th>
                                            <th>Latest File</th>
                                            <th>Upload Date</th>
                                            <th>Submitter</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Related reports will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>
    
    <!-- History Modal -->
    <div id="history-modal" class="modal">
        <div class="modal-content modal-lg">
            <div class="modal-header">
                <h3>KPI Performance History</h3>
                <span class="modal-close">&times;</span>
            </div>
            <div class="modal-body">
                <div id="history-content">
                    <!-- History content will be loaded here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Report Preview Modal -->
    <div id="report-preview-modal" class="modal">
        <div class="modal-content modal-xl">
            <div class="modal-header">
                <h3 id="preview-modal-title">Report Preview</h3>
                <span class="modal-close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="preview-container" style="height: 600px; border: 1px solid #ddd; border-radius: 8px; display: flex; flex-direction: column;">
                    <div id="preview-content" style="flex: 1; display: flex; justify-content: center; align-items: center; background: #f9f9f9; overflow: hidden;">
                        <p style="color: #999; font-style: italic;">Select a report to preview</p>
                    </div>
                    <div class="preview-controls" style="padding: 10px; border-top: 1px solid #ddd; display: flex; justify-content: center; align-items: center; gap: 10px;">
                        <button id="preview-prev-btn" class="action-button secondary" disabled>
                            <i class="fas fa-chevron-left"></i> Previous
                        </button>
                        <span id="preview-counter" style="margin: 0 15px;">0 of 0</span>
                        <button id="preview-next-btn" class="action-button secondary" disabled>
                            Next <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Report History Modal -->
    <div id="report-history-modal" class="modal">
        <div class="modal-content modal-xl">
            <div class="modal-header">
                <h3 id="history-modal-title">Report History</h3>
                <span class="modal-close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="history-modal-container" style="display: flex; flex-direction: column; height: 600px;">
                    <!-- Report Preview Panel (Top Section) -->
                    <div class="history-preview-panel" style="background: white; border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; flex: 1;">
                        <div class="history-preview-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #f0f0f0;">
                            <h4 id="history-preview-title">Report Preview</h4>
                            <div>
                                <span id="history-preview-info" style="font-size: 0.9rem; color: #666;"></span>
                            </div>
                        </div>
                        <div class="history-preview-content" style="display: flex; flex-direction: column; align-items: center; height: calc(100% - 60px);">
                            <div id="history-preview-container" style="width: 100%; flex: 1; display: flex; justify-content: center; align-items: center; overflow: hidden; border: 1px solid #ddd; border-radius: 8px; background: #f9f9f9;">
                                <p id="history-no-preview-message" style="color: #999; font-style: italic;">Select a report to preview</p>
                                <img id="history-preview-image" src="" alt="Report Preview" style="max-width: 100%; max-height: 100%; display: none;">
                            </div>
                            <div class="history-preview-controls" style="display: flex; justify-content: center; align-items: center; margin-top: 15px;">
                                <button id="history-prev-report-btn" class="action-button secondary" style="margin-right: 10px;" disabled>
                                    <i class="fas fa-chevron-left"></i> Previous
                                </button>
                                <span id="history-preview-counter" style="margin: 0 15px;">0 of 0</span>
                                <button id="history-next-report-btn" class="action-button secondary" style="margin-left: 10px;" disabled>
                                    Next <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Report History List (Bottom Section) -->
                    <div class="history-list-panel" style="background: white; border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); max-height: 300px; overflow-y: auto;">
                        <div class="history-list-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #f0f0f0;">
                            <h4 id="history-report-type-name">Report History</h4>
                            <span id="history-report-count" style="background: var(--secondary-color); color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem;">0 files</span>
                        </div>
                        <div class="history-list-content">
                            <div id="history-reports-list">
                                <!-- Historical reports will be loaded here -->
                                <div class="empty-state">
                                    <i class="fas fa-file-alt"></i>
                                    <h3>No Reports Found</h3>
                                    <p>No historical reports found for this report type</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Scorecard History Report Modal -->
    <div id="scorecard-history-modal" class="modal">
        <div class="modal-content modal-xl">
            <div class="modal-header">
                <h3 id="history-modal-title">Scorecard History Report</h3>
                <span class="modal-close">&times;</span>
            </div>
            <div class="modal-body">
                <!-- Filter Controls -->
                <div class="history-filters" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                        <div class="filter-group">
                            <label for="history-period-filter" style="font-weight: 500; margin-bottom: 5px; display: block;">Period Type:</label>
                            <select id="history-period-filter" onchange="updateHistoryFilters()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="month">Monthly</option>
                                <option value="quarter">Quarterly</option>
                                <option value="season">Seasonal</option>
                                <option value="year">Yearly</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="history-year-filter" style="font-weight: 500; margin-bottom: 5px; display: block;">Year:</label>
                            <select id="history-year-filter" onchange="updateHistoryFilters()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="all">All Years</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <button onclick="applyHistoryFilters()" style="background: var(--primary-color); color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                                <i class="fas fa-filter"></i> Apply Filters
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="history-report-content">
                    <!-- History report content will be loaded here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Period Selection Modal -->
    <div id="period-selection-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Select Month</h3>
                <span class="modal-close">&times;</span>
            </div>
            <div class="modal-body">
                <p>Please select a specific month to edit the scorecard:</p>
                <div id="period-selection-content" style="margin-top: 20px;">
                    <!-- Period options will be loaded here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Scorecard Editor Modal -->
    <div id="scorecard-editor-modal" class="modal" style="z-index: 10001;">
        <div class="modal-content modal-lg">
            <div class="modal-header">
                <h3 id="editor-modal-title">Scorecard Editor</h3>
                <span class="modal-close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="editor-container">
                    <!-- KPI Entry Form -->
                    <div class="editor-panel" style="background: white; border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <div class="editor-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #f0f0f0;">
                            <h4 id="editor-scorecard-title">KPI Entry & Performance</h4>
                            <span id="editor-period-badge" class="scorecard-period">June 2025</span>
                        </div>
                        
                        <div id="editor-kpi-form" class="kpi-entry-form" style="display: none;">
                            <!-- Performance Summary -->
                            <div id="editor-performance-summary" style="display: none;">
                                <div class="performance-summary-grid">
                                    <div class="summary-item">
                                        <div class="summary-value" id="editor-overall-score">0</div>
                                        <div class="summary-label">Overall Score</div>
                                    </div>
                                    <div class="summary-item">
                                        <div class="summary-value" id="editor-kpis-with-data">0/0</div>
                                        <div class="summary-label">KPIs with Data</div>
                                    </div>
                                    <div class="summary-item">
                                        <div class="summary-value" id="editor-on-target-count">0</div>
                                        <div class="summary-label">On Target</div>
                                    </div>
                                    <div class="summary-item">
                                        <div class="summary-value" id="editor-below-target-count">0</div>
                                        <div class="summary-label">Below Target</div>
                                    </div>
                                    <div class="summary-item">
                                        <div class="summary-value" id="editor-above-target-count">0</div>
                                        <div class="summary-label">Above Target</div>
                                    </div>
                                </div>
                            </div>
                            
                            <h4>KPI Values Entry</h4>
                            <div id="editor-kpi-entries">
                                <!-- KPI entries will be dynamically generated here -->
                            </div>
                            
                            <div class="action-buttons">
                                <button class="btn-save" onclick="saveEditorKpiData()">
                                    <i class="fas fa-save"></i> Save Data
                                </button>
                                <button class="btn-reset" onclick="resetEditorKpiData()">
                                    <i class="fas fa-undo"></i> Reset
                                </button>
                                <button class="btn-submit" onclick="submitEditorScorecard()" style="background-color: #28a745; color: white;">
                                    <i class="fas fa-paper-plane"></i> Submit for Approval
                                </button>
                                <button class="btn-approve" onclick="approveEditorScorecard()" style="background-color: #007bff; color: white; display: none;">
                                    <i class="fas fa-check"></i> Approve
                                </button>
                            </div>
                            
                            <!-- Status Display -->
                            <div class="status-display" id="editor-status-display" style="margin-top: 15px; padding: 10px; border-radius: 5px; display: none;">
                                <div class="status-info">
                                    <strong>Current Status:</strong> <span id="editor-current-status">Draft</span>
                                </div>
                                <div class="approval-info" id="editor-approval-info" style="margin-top: 5px; font-size: 0.9rem; color: #666;">
                                    <!-- Approval information will be displayed here -->
                                </div>
                            </div>
                            
                            <div class="auto-save-indicator" id="editor-auto-save-indicator">
                                <i class="fas fa-circle"></i>
                                <span>Ready to save</span>
                            </div>
                        </div>
                        
                        <div id="editor-no-scorecard" class="empty-state">
                            <i class="fas fa-chart-line"></i>
                            <h3>No Scorecard Selected</h3>
                            <p>Select a scorecard to start editing</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Monthly List Modal -->
    <div id="monthly-list-modal" class="modal">
        <div class="modal-content" style="width: 95%; max-width: 1400px;">
            <div class="modal-header">
                <h3>Monthly Scorecard List</h3>
                <span class="modal-close">&times;</span>
            </div>
            <div class="modal-body">
                <!-- Filter Controls -->
                <div class="monthly-list-filters" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                        <div class="filter-group">
                            <label for="monthly-month-filter" style="font-weight: 500; margin-bottom: 5px; display: block;">Month:</label>
                            <select id="monthly-month-filter" onchange="filterMonthlyList()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="">All Months</option>
                                <option value="1">January</option>
                                <option value="2">February</option>
                                <option value="3">March</option>
                                <option value="4">April</option>
                                <option value="5">May</option>
                                <option value="6">June</option>
                                <option value="7">July</option>
                                <option value="8">August</option>
                                <option value="9">September</option>
                                <option value="10">October</option>
                                <option value="11">November</option>
                                <option value="12">December</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="monthly-year-filter" style="font-weight: 500; margin-bottom: 5px; display: block;">Year:</label>
                            <select id="monthly-year-filter" onchange="filterMonthlyList()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="">All Years</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="monthly-department-filter" style="font-weight: 500; margin-bottom: 5px; display: block;">Department:</label>
                            <select id="monthly-department-filter" onchange="filterMonthlyList()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="">All Departments</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <button onclick="exportMonthlyListToExcel()" style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                                <i class="fas fa-file-excel"></i> Export to Excel
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Scorecard List Table -->
                <div class="table-container">
                    <table class="data-table" id="monthly-list-table" style="width: 100%;">
                        <thead>
                            <tr>
                                <th>Scorecard Name</th>
                                <th>Department</th>
                                <th>Score</th>
                                <th>Status</th>
                                <th style="min-width: 140px;">Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="monthly-list-tbody">
                            <!-- Scorecard data will be loaded here -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination Controls -->
                <div class="pagination-controls" style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <div class="pagination-info">
                        <span id="monthly-list-pagination-info">Showing 0 of 0 results</span>
                    </div>
                    <div class="pagination-buttons" style="display: flex; gap: 10px; align-items: center;">
                        <button id="monthly-list-prev-page" class="action-button small" onclick="goToMonthlyListPreviousPage()" disabled>
                            <i class="fas fa-chevron-left"></i> Previous
                        </button>
                        <div class="page-numbers" id="monthly-list-page-numbers" style="display: flex; gap: 5px;">
                            <!-- Page numbers will be generated here -->
                        </div>
                        <button id="monthly-list-next-page" class="action-button small" onclick="goToMonthlyListNextPage()" disabled>
                            Next <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                    <div class="pagination-size">
                        <label for="monthly-list-page-size" style="margin-right: 8px; font-weight: 500;">Show:</label>
                        <select id="monthly-list-page-size" onchange="changeMonthlyListPageSize()" style="padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="10">10</option>
                            <option value="25">25</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                        <span style="margin-left: 8px;">per page</span>
                    </div>
                </div>
                
                <div id="monthly-list-empty" class="empty-state" style="display: none;">
                    <i class="fas fa-chart-bar"></i>
                    <h3>No Scorecards Found</h3>
                    <p>No scorecards match the selected filters</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="assets/js/data.js"></script>
    <script src="assets/js/sidebar-manager.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="assets/js/supabase/config.js"></script>
    <script src="assets/js/supabase/auth.js"></script>
    <script src="assets/js/supabase/data.js"></script>
    <script src="assets/js/supabase/files.js"></script>
    <script src="assets/js/supabase/integration-manager.js"></script>
    
    <!-- Core Application Scripts -->
    <script src="assets/js/script.js"></script>
    <script src="assets/js/app.js"></script>
    
    <!-- Access Control Module -->
    <script src="assets/js/access-control.js"></script>
    
    <!-- Navigation Template -->
    <script src="assets/js/navigation-template.js"></script>
    
    <!-- Global Functions -->
    <script src="global-functions.js"></script>
    
    <script src="integration-fix.js?v=1.1"></script>
    
    <script>
        // Global variables
        let currentScorecard = null;
        let currentPeriod = { month: 6, year: 2025 };
        let currentKpiData = {};
        let autoSaveTimer = null;
        
        // Monthly List Pagination Variables
        let monthlyListCurrentPage = 1;
        let monthlyListPageSize = 10;
        let monthlyListTotalResults = 0;
        let monthlyListFilteredResults = [];
        
        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Initializing KPI Data Entry...');
            
            // Check if DB object is available
            if (typeof DB === 'undefined') {
                console.error('❌ DB object not found! This will cause issues with data loading.');
            } else {
                console.log('✅ DB object is available');
            }
            
            // Debug: Show departments data
            const departments = DB.get('departments') || [];
            console.log('🏢 Departments data:', departments);
            departments.forEach(dept => {
                console.log(`  - ${dept.name}: manager = "${dept.manager}"`);
            });
            
            // Debug: Show current user data
            const currentUser = DB.getCurrentUser();
            console.log('👤 Current user data:', currentUser);
            

            
            // Initialize Supabase integration (only if not already initialized)
            if (typeof supabaseIntegrationManager !== 'undefined' && !supabaseIntegrationManager.isInitialized) {
                supabaseIntegrationManager.initialize()
                    .then(() => {
                        console.log('✅ Supabase Integration Manager initialized');
                        loadScorecards();
                        loadDepartments();
                        setupEventListeners();
                        initializeRelatedReports();
                        initializeInlineHistoryReport();
                    })
                    .catch((error) => {
                        console.error('❌ Supabase initialization failed:', error);
                        loadScorecards();
                        loadDepartments();
                        setupEventListeners();
                        initializeRelatedReports();
                        initializeInlineHistoryReport();
                    });
            } else {
                console.log('ℹ️ Supabase Integration Manager already initialized or not available');
                loadScorecards();
                loadDepartments();
                setupEventListeners();
                initializeRelatedReports();
                initializeInlineHistoryReport();
            }
        });
        
        // Role-Based Access Control Functions
        function canEnterKpiValues(scorecard) {
            const currentUser = DB.getCurrentUser();
            if (!currentUser || !scorecard) return false;
            
            console.log('🔐 Checking KPI entry permissions for user:', currentUser.name, 'role:', currentUser.role);
            console.log('📊 Scorecard:', scorecard.name, 'department:', scorecard.department, 'responsible:', scorecard.responsible_person);
            
            // 1. User added to scorecard in scorecard setup (responsible_person)
            if (scorecard.responsible_person === currentUser.name) {
                console.log('✅ User is responsible person for this scorecard');
                return true;
            }
            
            // 2. Department Manager of the department setup on the scorecards
            if (currentUser.role === 'Manager') {
                const departments = DB.get('departments') || [];
                const department = departments.find(dept => dept.name === scorecard.department);
                console.log('🔍 Checking department:', department);
                if (department && department.manager) {
                    // Check for exact match or partial match (first name)
                    const managerName = department.manager.toLowerCase();
                    const userName = currentUser.name.toLowerCase();
                    const userNameParts = userName.split(' ');
                    const managerNameParts = managerName.split(' ');
                    
                    // Check exact match
                    if (managerName === userName) {
                        console.log('✅ User is department manager for this scorecard (exact match)');
                    return true;
                }
                    
                    // Check first name match
                    if (userNameParts[0] === managerNameParts[0]) {
                        console.log('✅ User is department manager for this scorecard (first name match)');
                        return true;
                    }
                    
                    // Check if user's name is contained in manager name or vice versa
                    if (managerName.includes(userName) || userName.includes(managerName)) {
                        console.log('✅ User is department manager for this scorecard (partial match)');
                        return true;
                    }
                }
            }
            
            // 3. HR Manager - can view all scorecards
            if (currentUser.role === 'HR Manager') {
                console.log('✅ User is HR manager, can view all scorecards');
                    return true;
                }
            
            // 3.5. Special case: Users who manage HR department should be treated as HR Manager
            if (currentUser.role === 'Manager' && currentUser.department === 'HR') {
                console.log('✅ User is HR department manager, treating as HR Manager');
                return true;
            }
            
            // 4. Admin - can view all scorecards
            if (currentUser.role === 'Admin') {
                console.log('✅ User is admin, can view all scorecards');
                return true;
            }
            
            console.log('❌ User does not have permission to enter KPI values');
            return false;
        }
        
        function canSubmitScorecard(scorecard) {
            const currentUser = DB.getCurrentUser();
            if (!currentUser || !scorecard) return false;
            
            console.log('🔐 Checking submit permissions for user:', currentUser.name, 'role:', currentUser.role);
            
            // Only Department Manager of the department added to scorecard in settings
            if (currentUser.role === 'Manager') {
                const departments = DB.get('departments') || [];
                const department = departments.find(dept => dept.name === scorecard.department);
                console.log('🔍 Checking department for submit:', department);
                if (department && department.manager) {
                    // Check for exact match or partial match (first name)
                    const managerName = department.manager.toLowerCase();
                    const userName = currentUser.name.toLowerCase();
                    const userNameParts = userName.split(' ');
                    const managerNameParts = managerName.split(' ');
                    
                    // Check exact match
                    if (managerName === userName) {
                        console.log('✅ User is department manager, can submit scorecard (exact match)');
                    return true;
                }
                    
                    // Check first name match
                    if (userNameParts[0] === managerNameParts[0]) {
                        console.log('✅ User is department manager, can submit scorecard (first name match)');
                        return true;
                    }
                    
                    // Check if user's name is contained in manager name or vice versa
                    if (managerName.includes(userName) || userName.includes(managerName)) {
                        console.log('✅ User is department manager, can submit scorecard (partial match)');
                        return true;
                    }
                }
            }
            
            // Responsible person can also submit their own scorecard
            if (scorecard.responsible_person === currentUser.name) {
                console.log('✅ User is responsible person, can submit scorecard');
                return true;
            }
            
            // Admin can submit any scorecard
            if (currentUser.role === 'Admin') {
                console.log('✅ User is admin, can submit any scorecard');
                return true;
            }
            
            console.log('❌ User does not have permission to submit scorecard');
            return false;
        }
        
        function canApproveScorecard(scorecard) {
            const currentUser = DB.getCurrentUser();
            if (!currentUser || !scorecard) return false;
            
            console.log('🔐 Checking approval permissions for user:', currentUser.name, 'role:', currentUser.role);
            
            // Only HR Manager can approve all scorecards
            if (currentUser.role === 'HR Manager') {
                    console.log('✅ User is HR manager, can approve scorecard');
                    return true;
                }
            
            // Special case: Users who manage HR department should be treated as HR Manager
            if (currentUser.role === 'Manager' && currentUser.department === 'HR') {
                console.log('✅ User is HR department manager, can approve scorecard');
                return true;
            }
            
            console.log('❌ User does not have permission to approve scorecard');
            return false;
        }
        
        function isScorecardLocked(scorecardResult) {
            if (!scorecardResult) return false;
            
            // Scorecard is locked if it's approved OR submitted (users can't edit submitted scorecards)
            const isLocked = scorecardResult.status === 'approved' || scorecardResult.status === 'submitted';
            console.log('🔒 Scorecard locked status:', isLocked, 'Status:', scorecardResult.status);
            return isLocked;
        }
        
        function updateButtonVisibility(canEnter, canSubmit, canApprove, isLocked) {
            console.log('🔧 Updating button visibility:', { canEnter, canSubmit, canApprove, isLocked });
            
            const saveBtn = document.querySelector('.btn-save');
            const resetBtn = document.querySelector('.btn-reset');
            const submitBtn = document.querySelector('.btn-submit');
            const approveBtn = document.querySelector('.btn-approve');
            const historyBtn = document.querySelector('.btn-history');
            const exportBtn = document.querySelector('.btn-history:last-child');
            
            // Save and Reset buttons - only visible if user can enter data and scorecard is not locked
            if (saveBtn) {
                saveBtn.style.display = (canEnter && !isLocked) ? 'inline-flex' : 'none';
            }
            if (resetBtn) {
                resetBtn.style.display = (canEnter && !isLocked) ? 'inline-flex' : 'none';
            }
            
            // Submit button - only visible to department managers and scorecard is not locked
            if (submitBtn) {
                // Managers should see submit button for draft scorecards (not locked)
                // The submit button should be visible for draft scorecards that managers can submit
                // For draft scorecards (not locked), managers should see the submit button
                const shouldShowSubmit = canSubmit && !isLocked;
                submitBtn.style.display = shouldShowSubmit ? 'inline-flex' : 'none';
                console.log('🔧 Submit button visibility:', { canSubmit, isLocked, shouldShowSubmit });
            }
            
            // Approve button - only visible to HR managers and scorecard is not locked
            if (approveBtn) {
                approveBtn.style.display = (canApprove && !isLocked) ? 'inline-flex' : 'none';
            }
            
            // History and Export buttons - always visible if user has any permissions
            if (historyBtn) {
                historyBtn.style.display = (canEnter || canSubmit || canApprove) ? 'inline-flex' : 'none';
            }
            if (exportBtn) {
                exportBtn.style.display = (canEnter || canSubmit || canApprove) ? 'inline-flex' : 'none';
            }
            
            console.log('✅ Button visibility updated');
        }
        
        async function submitScorecardForApproval() {
            if (!currentScorecard) {
                alert('Please select a scorecard first');
                return;
            }
            
            const currentUser = DB.getCurrentUser();
            if (!currentUser) {
                alert('Please log in to submit scorecard');
                return;
            }
            
            // Check if user can submit this scorecard
            if (!canSubmitScorecard(currentScorecard)) {
                alert('You do not have permission to submit this scorecard. Only the department manager can submit scorecards.');
                return;
            }
            
            try {
                // Find existing result or create new one
                const results = DB.get('scorecard_results') || [];
                let existingResult = results.find(r => 
                    r.scorecard_id === currentScorecard.id && 
                    r.period_month === currentPeriod.month && 
                    r.period_year === currentPeriod.year
                );
                
                if (existingResult) {
                    // Update existing result
                    const updates = {
                        kpi_values: { ...currentKpiData },
                        total_score: calculateTotalScore(),
                        status: 'submitted',
                        submitted_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    };
                    
                    // Use integration manager to update record (handles both local and Supabase)
                    if (typeof supabaseIntegrationManager !== 'undefined' && supabaseIntegrationManager.isInitialized) {
                        const updatedResult = await supabaseIntegrationManager.updateRecord('scorecard_results', existingResult.id, updates);
                        console.log('✅ Scorecard result updated via integration manager:', updatedResult);
                } else {
                        // Fallback to local storage only
                        const updatedResult = DB.update('scorecard_results', existingResult.id, updates);
                        console.log('✅ Scorecard result updated locally only:', updatedResult);
                    }
                } else {
                    // Create new result (don't include ID - let Supabase assign it)
                    const newResult = {
                        scorecard_id: currentScorecard.id,
                        user_id: currentUser.id,
                        period_month: currentPeriod.month,
                        period_year: currentPeriod.year,
                        kpi_values: { ...currentKpiData },
                        total_score: calculateTotalScore(),
                        status: 'submitted',
                        submitted_at: new Date().toISOString(),
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    };
                    
                    // Use integration manager to create record (handles both local and Supabase)
                    if (typeof supabaseIntegrationManager !== 'undefined' && supabaseIntegrationManager.isInitialized) {
                        const addedResult = await supabaseIntegrationManager.createRecord('scorecard_results', newResult);
                        console.log('✅ Scorecard result created via integration manager:', addedResult);
                    } else {
                        // Fallback to local storage only
                    const addedResult = DB.add('scorecard_results', newResult);
                        console.log('✅ Scorecard result created locally only:', addedResult);
                    }
                }
                
                alert('Scorecard submitted for approval successfully!');
                loadPeriodData(); // Refresh the display
                
            } catch (error) {
                console.error('❌ Error submitting scorecard:', error);
                alert('Error submitting scorecard. Please try again.');
            }
        }
        
        async function approveScorecard(scorecardResultId) {
            const currentUser = DB.getCurrentUser();
            if (!currentUser) {
                alert('Please log in to approve scorecard');
                return;
            }
            
            const scorecardResult = DB.getById('scorecard_results', scorecardResultId);
            if (!scorecardResult) {
                alert('Scorecard result not found');
                return;
            }
            
            const scorecard = DB.getById('scorecards', scorecardResult.scorecard_id);
            if (!scorecard) {
                alert('Scorecard not found');
                return;
            }
            
            if (!canApproveScorecard(scorecard)) {
                alert('You do not have permission to approve this scorecard. Only the HR manager can approve scorecards.');
                return;
            }
            
            try {
                // Only HR Manager can approve (final approval)
                const updates = {
                    status: 'approved',
                    updated_at: new Date().toISOString()
                };
                
                // Use integration manager to update record (handles both local and Supabase)
                if (typeof supabaseIntegrationManager !== 'undefined' && supabaseIntegrationManager.isInitialized) {
                    const updatedResult = await supabaseIntegrationManager.updateRecord('scorecard_results', scorecardResultId, updates);
                    console.log('✅ Scorecard result approved via integration manager:', updatedResult);
                } else {
                    // Fallback to local storage only
                    const updatedResult = DB.update('scorecard_results', scorecardResultId, updates);
                    console.log('✅ Scorecard result approved locally only:', updatedResult);
                }
                
                alert('Scorecard approved successfully! The scorecard is now locked for editing.');
                loadPeriodData(); // Refresh the display
                
            } catch (error) {
                console.error('❌ Error approving scorecard:', error);
                alert('Error approving scorecard. Please try again.');
            }
        }
        

        
        function calculateTotalScore() {
            if (!currentScorecard) return 0;
            
            const kpis = DB.getKPIsByScorecard(currentScorecard.id);
            let totalScore = 0;
            let totalWeight = 0;
            
            kpis.forEach(kpi => {
                const value = currentKpiData[kpi.id];
                if (value !== null && !isNaN(value)) {
                    const percentage = (value / kpi.target) * 100;
                    const weightedScore = (percentage * kpi.weight) / 100;
                    totalScore += weightedScore;
                    totalWeight += kpi.weight;
                }
            });
            
            return totalWeight > 0 ? (totalScore / totalWeight) * 100 : 0;
        }
        
        function approveCurrentScorecard() {
            if (!currentScorecard) {
                alert('Please select a scorecard first');
                return;
            }
            
            const currentUser = DB.getCurrentUser();
            if (!currentUser) {
                alert('Please log in to approve scorecard');
                return;
            }
            
            // Check if user can approve this scorecard
            if (!canApproveScorecard(currentScorecard)) {
                alert('You do not have permission to approve this scorecard. Only the HR manager can approve scorecards.');
                return;
            }
            
            // Find the current scorecard result
            const results = DB.get('scorecard_results') || [];
            const currentResult = results.find(r => 
                r.scorecard_id === currentScorecard.id && 
                r.period_month === currentPeriod.month && 
                r.period_year === currentPeriod.year
            );
            
            if (!currentResult) {
                alert('No scorecard result found for the current period');
                return;
            }
            
            approveScorecard(currentResult.id);
        }
        
        function updateStatusDisplay(scorecardResult) {
            const statusDisplay = document.getElementById('status-display');
            const currentStatus = document.getElementById('current-status');
            const approvalInfo = document.getElementById('approval-info');
            const approveBtn = document.querySelector('.btn-approve');
            
            if (!statusDisplay || !currentStatus || !approvalInfo) return;
            
            if (!scorecardResult) {
                statusDisplay.style.display = 'none';
                if (approveBtn) approveBtn.style.display = 'none';
                return;
            }
            
            statusDisplay.style.display = 'block';
            
            // Use the status field from the database
            const status = scorecardResult.status || 'draft';
            
            currentStatus.textContent = status.charAt(0).toUpperCase() + status.slice(1);
            
            // Set status color
            let statusColor = '#6c757d'; // Default gray
            if (status === 'approved') statusColor = '#28a745'; // Green
            else if (status === 'submitted') statusColor = '#ffc107'; // Yellow
            else if (status === 'draft') statusColor = '#6c757d'; // Gray
            
            currentStatus.style.color = statusColor;
            currentStatus.style.fontWeight = 'bold';
            
            // Show approval information
            let approvalText = '';
            if (status === 'approved') {
                approvalText = 'Scorecard has been approved and is locked for editing';
            } else if (status === 'submitted') {
                approvalText = 'Scorecard has been submitted and is awaiting approval';
            } else if (status === 'draft') {
                approvalText = 'Ready for submission';
            }
            
            approvalInfo.textContent = approvalText;
            
            // Show/hide approve button based on permissions
            if (approveBtn) {
                const canApprove = canApproveScorecard(currentScorecard);
                approveBtn.style.display = canApprove ? 'inline-block' : 'none';
                
                // Update button text based on user role
                const currentUser = DB.getCurrentUser();
                if (currentUser && currentUser.role === 'HR Manager') {
                    approveBtn.innerHTML = '<i class="fas fa-check"></i> Final Approve';
                } else {
                    approveBtn.innerHTML = '<i class="fas fa-check"></i> Approve';
                }
            }
        }
        
        // Essential functions for KPI Data Entry
        function setupEventListeners() {
            console.log('🔧 Setting up event listeners...');
            
            // Scorecard filter
            const scorecardFilter = document.getElementById('scorecard-filter');
            const monthlyListBtn = document.getElementById('monthly-list-btn');
            if (scorecardFilter) {
                scorecardFilter.addEventListener('change', function() {
                    console.log('📊 Scorecard filter changed to:', this.value);
                const scorecardId = this.value;
                if (scorecardId) {
                    loadScorecard(scorecardId);
                        if (monthlyListBtn) monthlyListBtn.disabled = false;
                } else {
                    clearScorecard();
                        if (monthlyListBtn) monthlyListBtn.disabled = true;
                    }
                });
                // Initially disable button
                if (monthlyListBtn) monthlyListBtn.disabled = true;
                // Add click event
                if (monthlyListBtn) {
                    monthlyListBtn.addEventListener('click', function() {
                        if (!this.disabled) openMonthlyListModal();
                    });
                }
                console.log('✅ Scorecard filter event listener attached');
            } else {
                console.warn('⚠️ Could not find scorecard-filter element');
            }
            
            // Department filter
            const departmentFilter = document.getElementById('department-filter');
            const scorecardFilterElement = document.getElementById('scorecard-filter');
            if (departmentFilter) {
                departmentFilter.addEventListener('change', function() {
                    filterScorecards();
                    // Enable scorecard filter only if a department is selected
                    if (departmentFilter.value) {
                        scorecardFilterElement.disabled = false;
                    } else {
                        scorecardFilterElement.disabled = true;
                        scorecardFilterElement.innerHTML = '<option value="">Select Scorecard</option>';
                    }
                });
                // Initially disable scorecard filter
                scorecardFilterElement.disabled = true;
            }
            console.log('✅ Department filter event listener attached');
            

            
            // Modal close buttons
            document.querySelectorAll('.modal-close').forEach(btn => {
                btn.addEventListener('click', closeModals);
            });
            
            // Cancel buttons
            document.querySelectorAll('.cancel-btn').forEach(btn => {
                btn.addEventListener('click', closeModals);
            });
            
            // History modal navigation buttons
            const historyPrevBtn = document.getElementById('history-prev-report-btn');
            const historyNextBtn = document.getElementById('history-next-report-btn');
            
            if (historyPrevBtn) {
                historyPrevBtn.addEventListener('click', () => {
                    if (currentHistoryIndex > 0) {
                        selectHistoryReport(currentHistoryIndex - 1);
                    }
                });
            }
            
            if (historyNextBtn) {
                historyNextBtn.addEventListener('click', () => {
                    if (currentHistoryIndex < currentHistoryReports.length - 1) {
                        selectHistoryReport(currentHistoryIndex + 1);
                    }
                });
            }
        }
        
        function loadScorecards() {
            const scorecards = DB.get('scorecards') || [];
            const scorecardFilter = document.getElementById('scorecard-filter');
            const departmentFilter = document.getElementById('department-filter');
            
            // Clear existing options
            scorecardFilter.innerHTML = '<option value="">Select Scorecard</option>';
            departmentFilter.innerHTML = '<option value="">All Departments</option>';
            
            // Add scorecard options
            scorecards.forEach(scorecard => {
                const option = document.createElement('option');
                option.value = scorecard.id;
                option.textContent = `${scorecard.name} (${scorecard.department})`;
                scorecardFilter.appendChild(option);
            });
            
            // Add department options
            const departments = DB.get('departments') || [];
            departments.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept.name;
                option.textContent = dept.name;
                departmentFilter.appendChild(option);
            });
            
            console.log(`✅ Loaded ${scorecards.length} scorecards and ${departments.length} departments`);
        }
        
        function loadDepartments() {
            const departments = DB.get('departments') || [];
            const departmentFilter = document.getElementById('department-filter');
            
            if (departmentFilter) {
                // Clear existing options
                departmentFilter.innerHTML = '<option value="">All Departments</option>';
                
                // Add department options
                departments.forEach(dept => {
                    const option = document.createElement('option');
                    option.value = dept.name;
                    option.textContent = dept.name;
                    departmentFilter.appendChild(option);
                });
                
                console.log(`✅ Loaded ${departments.length} departments`);
            }
        }
        

        
        function loadScorecard(scorecardId) {
            console.log(`📊 Loading scorecard: ${scorecardId}`);
            
            const scorecard = DB.getById('scorecards', parseInt(scorecardId));
            if (!scorecard) {
                console.error('❌ Scorecard not found');
                return;
            }
            
            currentScorecard = scorecard;
            console.log('✅ Scorecard loaded:', scorecard);
            
            // Update the inline history title
            const titleElement = document.getElementById('inline-history-title');
            if (titleElement) {
                titleElement.textContent = `Scorecard History Report - ${scorecard.name}`;
            }
            
            // Initialize inline history report
            initializeInlineHistoryReport();
            
            // Load related reports for this scorecard
            const kpis = DB.getKPIsByScorecard(scorecard.id);
            loadRelatedReports(scorecard, kpis);
        }
        
        // New functions for related reports functionality
        function loadRelatedReports(scorecard, kpis) {
            console.log('🔄 Loading related reports for scorecard:', scorecard.name);
            
            if (!kpis || kpis.length === 0) {
                console.log('⚠️ No KPIs found for this scorecard');
                showNoReportsMessage();
                return;
            }
            
            // Collect all unique report type IDs from KPIs
            const reportTypeIds = new Set();
            kpis.forEach(kpi => {
                if (kpi.linked_report_types && Array.isArray(kpi.linked_report_types)) {
                    kpi.linked_report_types.forEach(rtId => reportTypeIds.add(rtId));
                }
            });
            
            console.log('📋 Found report type IDs:', Array.from(reportTypeIds));
            
            if (reportTypeIds.size === 0) {
                console.log('⚠️ No report types linked to KPIs');
                showNoReportsMessage();
                return;
            }
            
            // Get report types and their latest reports
            const reportTypes = DB.get('reportTypes') || [];
            const reports = DB.get('reports') || [];
            
            const relatedReportTypes = reportTypes.filter(rt => reportTypeIds.has(rt.id));
            console.log('📄 Related report types:', relatedReportTypes);
            
            // For each report type, find the latest report using report_type_id
            const latestReports = [];
            relatedReportTypes.forEach(reportType => {
                // Filter reports by report_type_id (not reportTypeId)
                const reportTypeReports = reports.filter(r => {
                    const reportTypeId = r.report_type_id || r.reportTypeId;
                    return reportTypeId == reportType.id; // Use == for type coercion
                });
                
                console.log(`📊 Found ${reportTypeReports.length} reports for report type "${reportType.name}" (ID: ${reportType.id})`);
                
                if (reportTypeReports.length > 0) {
                    // Sort by date and get the latest
                    const sortedReports = reportTypeReports.sort((a, b) => {
                        const dateA = new Date(a.created_at || a.date || 0);
                        const dateB = new Date(b.created_at || b.date || 0);
                        return dateB - dateA;
                    });
                    const latestReport = sortedReports[0];
                    latestReports.push({
                        reportType: reportType,
                        latestReport: latestReport,
                        allReports: sortedReports
                    });
                } else {
                    // No reports for this type
                    latestReports.push({
                        reportType: reportType,
                        latestReport: null,
                        allReports: []
                    });
                }
            });
            
            console.log('📊 Latest reports found:', latestReports);
            renderRelatedReports(latestReports);
        }
        
        function renderRelatedReports(latestReports) {
            const tableBody = document.querySelector('#related-reports-table tbody');
            if (!tableBody) return;

            if (latestReports.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:#999;">No related reports found</td></tr>`;
                // Optionally clear the preview pane here
                if (typeof updatePreview === 'function') {
                    updatePreview({}); // Clear preview
                }
                return;
            }
            
            
            // Render table
            tableBody.innerHTML = latestReports.map(item => {
                const reportType = item.reportType;
                const latestReport = item.latestReport;
                
                if (latestReport) {
                    // Get department name
                    const departmentName = latestReport.department || 'N/A';
                    const uploadDate = latestReport.created_at || latestReport.date;
                    const submitter = latestReport.submitter || 'Unknown';
                    
                    return `
                        <tr data-report-id="${latestReport.id}" data-report-type-id="${reportType.id}" onclick="previewReport('${latestReport.id}')" style="cursor: pointer;">
                            <td><strong>${reportType.name}</strong></td>
                            <td>${departmentName}</td>
                            <td>${latestReport.name}</td>
                            <td>${uploadDate ? new Date(uploadDate).toLocaleDateString() : 'N/A'}</td>
                            <td>${submitter}</td>
                            <td>
                                <button class="action-icon view" onclick="event.stopPropagation(); viewReportDetails('${latestReport.id}')" title="View Details">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="action-icon preview" onclick="event.stopPropagation(); previewReport('${latestReport.id}')" title="Preview">
                                    <i class="fas fa-search"></i>
                                </button>
                                <button class="action-icon download" onclick="event.stopPropagation(); downloadReport('${latestReport.id}')" title="Download">
                                    <i class="fas fa-download"></i>
                                </button>
                            </td>
                        </tr>
                    `;
            } else {
                    return `
                        <tr>
                            <td><strong>${reportType.name}</strong></td>
                            <td colspan="4" style="text-align: center; color: #999; font-style: italic;">
                                No reports available
                            </td>
                            <td>
                                <button class="action-icon add" onclick="uploadNewReport('${reportType.id}')" title="Upload Report">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                }
            }).join('');
        }
        
        function showNoReportsMessage() {
            const tableBody = document.querySelector('#related-reports-table tbody');
            if (tableBody) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; color: #999;">
                            <div class="empty-state">
                                <i class="fas fa-file-alt"></i>
                                <h3>No Related Reports</h3>
                                <p>No report types are linked to the KPIs in this scorecard</p>
                            </div>
                        </td>
                    </tr>
                `;
            }
        }
        
        function getPreviewImageForFormat(format) {
            switch(format.toLowerCase()) {
                case 'pdf': return 'assets/images/pdf-preview.png';
                case 'excel': return 'assets/images/excel-preview.png';
                case 'word': return 'assets/images/word-preview.png';
                case 'powerpoint': return 'assets/images/powerpoint-preview.png';
                default: return 'assets/images/generic-preview.png';
            }
        }
        
        function viewReportDetails(reportId) {
            console.log('🔍 Viewing report history for report ID:', reportId);
            
            const reports = DB.get('reports') || [];
            const report = reports.find(r => r.id == reportId);
            
            if (!report) {
                alert('Report not found');
                return;
            }
            
            // Get the report type for this report
            const reportTypeId = report.report_type_id || report.reportTypeId;
            const reportTypes = DB.get('reportTypes') || [];
            const reportType = reportTypes.find(rt => rt.id == reportTypeId);
            
            if (!reportType) {
                alert('Report type not found');
                return;
            }
            
            // Open the history modal and load all reports for this specific report type only
            openReportHistoryModal(reportType, reportId);
        }
        
        function previewReport(reportId) {
            console.log('👁️ Previewing report for report ID:', reportId);
            
            const reports = DB.get('reports') || [];
            const report = reports.find(r => r.id == reportId);
            
            if (!report) {
                alert('Report not found');
                return;
            }
            
            // Store current report for navigation
            window.currentPreviewReport = report;
            window.currentPreviewReports = [report];
            window.currentPreviewIndex = 0;
            
            // Update preview in the pane (not modal)
            updatePreview(report);
            updatePreviewNavigation();
        }
        
        function updatePreview(report) {
            const previewContainer = document.getElementById('preview-container');
            const previewTitle = document.getElementById('preview-title');
            const previewInfo = document.getElementById('preview-info');

            if (!previewContainer || !previewTitle || !previewInfo) {
                console.error('❌ Preview elements not found:', {
                    previewContainer: !!previewContainer,
                    previewTitle: !!previewTitle,
                    previewInfo: !!previewInfo
                });
                return;
            }

            // Clear existing content but preserve the structure
            previewContainer.innerHTML = `
                <p id="no-preview-message" style="color: #999; font-style: italic;">Select a report to preview</p>
                <img id="preview-image" src="" alt="Report Preview" style="max-width: 100%; max-height: 400px; display: none;">
            `;
            
            // Re-get the elements after clearing
            const previewImage = document.getElementById('preview-image');
            const noPreviewMessage = document.getElementById('no-preview-message');
            
            if (previewImage) {
                previewImage.src = ''; // Clear previous image source
                previewImage.style.display = 'none'; // Hide image
            }
            previewTitle.textContent = 'Report Preview';
            previewInfo.textContent = '';
            if (noPreviewMessage) {
                noPreviewMessage.style.display = 'block'; // Show no preview message
            }

            console.log('🔍 Previewing report:', report);
            
            // Handle both report_url and fileURL field names for compatibility
            const fileUrl = report.report_url || report.fileURL;
            console.log('📁 File URL:', fileUrl);
            console.log('📄 File name:', report.name);
            
            if (!fileUrl) {
                previewContainer.innerHTML = `
                    <div style="text-align: center; color: #999;">
                        <i class="fas fa-file-alt" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                        <p>No file URL available for preview</p>
                    </div>
                `;
                previewImage.style.display = 'none'; // Ensure image is hidden
                previewInfo.textContent = '';
                noPreviewMessage.style.display = 'block';
                return;
            }
            
            // Determine file type and create appropriate preview
            const fileName = report.name || 'Unknown file';
            let fileExtension = getFileExtension(fileName);
            console.log('🔍 Initial file extension from filename:', fileExtension);
            
            // If no extension found in filename or if it's invalid, try to extract from URL
            if ((fileExtension === 'Unknown' || fileExtension.length > 4) && fileUrl.includes('/')) {
                console.log('🔍 Extension is invalid or unknown, checking URL...');
                const urlParts = fileUrl.split('/');
                const lastPart = decodeURIComponent(urlParts[urlParts.length - 1]);
                console.log('🔍 Decoded URL last part:', lastPart);
                const urlExtensionMatch = lastPart.match(/\.([a-zA-Z0-9]+)$/);
                if (urlExtensionMatch) {
                    fileExtension = urlExtensionMatch[1].toLowerCase();
                    console.log('🔍 Extracted extension from URL:', fileExtension);
                } else {
                    console.log('🔍 No extension found in URL');
                }
            }
            
            console.log('🔍 Detected file extension:', fileExtension);
            
            // Check if it's an image
            if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'].includes(fileExtension)) {
                console.log('🖼️ Loading image preview');
                const img = document.createElement('img');
                img.src = fileUrl;
                img.style.maxWidth = '100%';
                img.style.maxHeight = '100%';
                img.style.objectFit = 'contain';
                img.onload = () => {
                    const currentPreviewImage = document.getElementById('preview-image');
                    const currentNoPreviewMessage = document.getElementById('no-preview-message');
                    if (currentPreviewImage) {
                        currentPreviewImage.src = fileUrl;
                        currentPreviewImage.style.display = 'block'; // Show image
                    }
                    previewTitle.textContent = `Preview: ${fileName}`;
                    previewInfo.textContent = `File: ${fileName} | Type: ${fileExtension.toUpperCase()}`;
                    if (currentNoPreviewMessage) {
                        currentNoPreviewMessage.style.display = 'none'; // Hide no preview message
                    }
                    console.log('✅ Image loaded successfully');
                };
                img.onerror = () => {
                    console.error('❌ Failed to load image');
                    showFileNotAccessiblePreview(previewContainer, fileName, fileUrl, 'image');
                };
                previewContainer.appendChild(img);
            }
            // Check if it's a PDF
            else if (fileExtension === 'pdf') {
                console.log('📄 Loading PDF preview');
                const iframe = document.createElement('iframe');
                iframe.src = fileUrl;
                iframe.style.width = '100%';
                iframe.style.height = '100%';
                iframe.style.border = 'none';
                iframe.onload = () => {
                    const currentPreviewImage = document.getElementById('preview-image');
                    const currentNoPreviewMessage = document.getElementById('no-preview-message');
                    if (currentPreviewImage) {
                        currentPreviewImage.src = fileUrl;
                        currentPreviewImage.style.display = 'block'; // Show image
                    }
                    previewTitle.textContent = `Preview: ${fileName}`;
                    previewInfo.textContent = `File: ${fileName} | Type: ${fileExtension.toUpperCase()}`;
                    if (currentNoPreviewMessage) {
                        currentNoPreviewMessage.style.display = 'none'; // Hide no preview message
                    }
                    console.log('✅ PDF loaded successfully');
                };
                iframe.onerror = () => {
                    console.error('❌ Failed to load PDF');
                    showFileNotAccessiblePreview(previewContainer, fileName, fileUrl, 'pdf');
                };
                previewContainer.appendChild(iframe);
            }
            // Check if it's a video
            else if (['mp4', 'webm', 'ogg', 'mov', 'avi'].includes(fileExtension)) {
                console.log('🎥 Loading video preview');
                
                // Clear container and set up video preview
                previewContainer.innerHTML = '';
                
                const video = document.createElement('video');
                video.src = fileUrl;
                video.controls = true;
                video.style.maxWidth = '100%';
                video.style.maxHeight = '400px';
                video.style.width = 'auto';
                video.style.height = 'auto';
                video.style.objectFit = 'contain';
                video.style.display = 'block';
                
                // Add proper video event handlers
                video.addEventListener('loadedmetadata', () => {
                    console.log('✅ Video metadata loaded');
                    previewTitle.textContent = `Preview: ${fileName}`;
                    previewInfo.textContent = `File: ${fileName} | Type: ${fileExtension.toUpperCase()}`;
                    const noPreviewMessage = document.getElementById('no-preview-message');
                    if (noPreviewMessage) {
                        noPreviewMessage.style.display = 'none';
                    }
                });
                
                video.addEventListener('canplay', () => {
                    console.log('✅ Video can start playing');
                });
                
                video.addEventListener('error', (e) => {
                    console.error('❌ Failed to load video:', e);
                    showFileNotAccessiblePreview(previewContainer, fileName, fileUrl, 'video');
                });
                
                // Add video to container
                previewContainer.appendChild(video);
                
                // Update title and info immediately
                previewTitle.textContent = `Preview: ${fileName}`;
                previewInfo.textContent = `File: ${fileName} | Type: ${fileExtension.toUpperCase()}`;
                const noPreviewMessage = document.getElementById('no-preview-message');
                if (noPreviewMessage) {
                    noPreviewMessage.style.display = 'none';
                }
            }
            // Check if it's a document
            else if (['doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx', 'txt'].includes(fileExtension)) {
                console.log('📄 Loading document preview');
                
                // Try to use Microsoft Office Online viewer for Office documents
                if (['doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx'].includes(fileExtension)) {
                    const officeViewerUrl = `https://view.officeapps.live.com/op/embed.aspx?src=${encodeURIComponent(fileUrl)}&wdAllowInteractivity=False`;
                    
                    const iframe = document.createElement('iframe');
                    iframe.src = officeViewerUrl;
                    iframe.style.width = '100%';
                    iframe.style.height = '100%';
                    iframe.style.minHeight = '100%';
                    iframe.style.display = 'block';
                    iframe.style.border = 'none';
                    iframe.onload = () => {
                        const currentPreviewImage = document.getElementById('preview-image');
                        const currentNoPreviewMessage = document.getElementById('no-preview-message');
                        if (currentPreviewImage) {
                            currentPreviewImage.src = fileUrl;
                            currentPreviewImage.style.display = 'block'; // Show image
                        }
                        previewTitle.textContent = `Preview: ${fileName}`;
                        previewInfo.textContent = `File: ${fileName} | Type: ${fileExtension.toUpperCase()}`;
                        if (currentNoPreviewMessage) {
                            currentNoPreviewMessage.style.display = 'none'; // Hide no preview message
                        }
                        console.log('✅ Office document loaded successfully');
                    };
                    iframe.onerror = () => {
                        console.error('❌ Failed to load Office document');
                        showDocumentFallbackPreview(previewContainer, fileName, fileUrl, fileExtension);
                    };
                    previewContainer.appendChild(iframe);
                } else {
                    // For text files, show content directly
                    showDocumentFallbackPreview(previewContainer, fileName, fileUrl, fileExtension);
                }
            }
            // Default file preview
            else {
                console.log('📁 Showing generic file preview');
                previewContainer.innerHTML = `
                    <div style="text-align: center; color: #999;">
                        <i class="fas fa-file" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                        <p><strong>${fileName}</strong></p>
                        <p style="font-size: 0.8rem;">Preview not available for this file type</p>
                        <p style="font-size: 0.8rem;">Click download to access the file</p>
                        <p style="font-size: 0.8rem;">File type: ${fileExtension ? fileExtension.toUpperCase() : 'Unknown'}</p>
                        <p style="font-size: 0.8rem;">URL: ${fileUrl}</p>
                    </div>
                `;
                const currentPreviewImage = document.getElementById('preview-image');
                const currentNoPreviewMessage = document.getElementById('no-preview-message');
                if (currentPreviewImage) {
                    currentPreviewImage.style.display = 'none'; // Ensure image is hidden
                }
                previewInfo.textContent = '';
                if (currentNoPreviewMessage) {
                    currentNoPreviewMessage.style.display = 'block';
                }
            }
        }
        
        function updatePreviewNavigation() {
            const reports = window.currentPreviewReports;
            const currentIndex = window.currentPreviewIndex;
            
            const prevBtn = document.getElementById('prev-report-btn');
            const nextBtn = document.getElementById('next-report-btn');
            const counter = document.getElementById('preview-counter');
            
            if (prevBtn) prevBtn.disabled = currentIndex <= 0;
            if (nextBtn) nextBtn.disabled = currentIndex >= reports.length - 1;
            if (counter) counter.textContent = `${currentIndex + 1} of ${reports.length}`;
        }
        
        function showDocumentFallbackPreview(previewContainer, fileName, fileUrl, fileExtension) {
            const previewImage = document.getElementById('preview-image');
            const previewInfo = document.getElementById('preview-info');
            const noPreviewMessage = document.getElementById('no-preview-message');
            
            previewContainer.innerHTML = `
                <div style="text-align: center; color: #999;">
                    <i class="fas fa-file-alt" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                    <p><strong>${fileName}</strong></p>
                    <p style="font-size: 0.8rem;">Document preview not available</p>
                    <p style="font-size: 0.8rem;">File type: ${fileExtension ? fileExtension.toUpperCase() : 'Unknown'}</p>
                    <a href="${fileUrl}" target="_blank" class="action-button primary" style="margin-top: 10px;">
                        <i class="fas fa-external-link-alt"></i> Open in New Tab
                    </a>
                </div>
            `;
            if (previewImage) previewImage.style.display = 'none'; // Ensure image is hidden
            if (previewInfo) previewInfo.textContent = '';
            if (noPreviewMessage) noPreviewMessage.style.display = 'block';
        }
        
        function showFileNotAccessiblePreview(previewContainer, fileName, fileUrl, fileType) {
            const previewImage = document.getElementById('preview-image');
            const previewInfo = document.getElementById('preview-info');
            const noPreviewMessage = document.getElementById('no-preview-message');
            
            previewContainer.innerHTML = `
                <div style="text-align: center; color: #999;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem; color: #ffc107;"></i>
                    <p><strong>${fileName}</strong></p>
                    <p style="font-size: 0.8rem;">File not accessible</p>
                    <p style="font-size: 0.8rem;">The file may have been moved or deleted</p>
                    <p style="font-size: 0.8rem;">File type: ${fileType}</p>
                    <p style="font-size: 0.8rem;">URL: ${fileUrl}</p>
                </div>
            `;
            if (previewImage) previewImage.style.display = 'none'; // Ensure image is hidden
            if (previewInfo) previewInfo.textContent = '';
            if (noPreviewMessage) noPreviewMessage.style.display = 'block';
        }
        
        function downloadReport(reportId) {
            console.log('📥 Downloading report:', reportId);
            
            const reports = DB.get('reports') || [];
            const report = reports.find(r => r.id == reportId);
            
            if (!report) {
                alert('Report not found');
                return;
            }
            
            const fileUrl = report.report_url || report.fileURL;
            if (!fileUrl) {
                alert('No file URL available for download');
                return;
            }
            
            // Create a temporary link to trigger download
            const link = document.createElement('a');
            link.href = fileUrl;
            link.download = report.name || 'report';
            link.target = '_blank';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            console.log('✅ Download initiated for:', report.name);
        }
        
        function uploadNewReport(reportTypeId) {
            console.log('📤 Redirecting to reports page for upload:', reportTypeId);
            // Redirect to reports page with upload context
            window.location.href = `reports.html?reportType=${reportTypeId}&upload=true`;
        }
        
        // Report History Modal Functions
        let currentHistoryReportType = null;
        let currentHistoryReports = [];
        let currentHistoryIndex = 0;
        
        function openReportHistoryModal(reportType, selectedReportId = null) {
            console.log('📋 Opening report history modal for:', reportType.name);
            
            currentHistoryReportType = reportType;
            
            // Update modal title
            const modalTitle = document.getElementById('history-modal-title');
            if (modalTitle) {
                modalTitle.textContent = `Report History - ${reportType.name}`;
            }
            
            // Update report type name
            const reportTypeName = document.getElementById('history-report-type-name');
            if (reportTypeName) {
                reportTypeName.textContent = reportType.name;
            }
            
            // Load all reports for this report type
            loadReportHistory(reportType, selectedReportId);
            
            // Show the modal
            document.getElementById('report-history-modal').style.display = 'block';
        }
        
        function loadReportHistory(reportType, selectedReportId = null) {
            console.log('📋 Loading report history for specific report type:', reportType.name, 'ID:', reportType.id);
            
            const reports = DB.get('reports') || [];
            
            // Filter reports by the specific report type ID only
            const reportTypeReports = reports.filter(r => {
                const reportTypeId = r.report_type_id || r.reportTypeId;
                return reportTypeId == reportType.id; // Only this specific report type
            });
            
            console.log(`📊 Found ${reportTypeReports.length} reports for report type "${reportType.name}" (ID: ${reportType.id})`);
            
            // Sort by date (newest first)
            reportTypeReports.sort((a, b) => {
                const dateA = new Date(a.created_at || a.date || 0);
                const dateB = new Date(b.created_at || b.date || 0);
                return dateB - dateA;
            });
            
            currentHistoryReports = reportTypeReports;
            
            // Update report count
            const reportCount = document.getElementById('history-report-count');
            if (reportCount) {
                reportCount.textContent = `${reportTypeReports.length} files`;
            }
            
            // Render the reports list
            renderReportHistoryList(reportTypeReports, selectedReportId);
            
            // If a specific report was selected, preview it
            if (selectedReportId) {
                const selectedIndex = reportTypeReports.findIndex(r => r.id == selectedReportId);
                if (selectedIndex !== -1) {
                    currentHistoryIndex = selectedIndex;
                    previewHistoryReport(reportTypeReports[selectedIndex]);
                }
            } else if (reportTypeReports.length > 0) {
                // Preview the first report
                currentHistoryIndex = 0;
                previewHistoryReport(reportTypeReports[0]);
            } else {
                // Clear preview
                clearHistoryPreview();
            }
            
            // Update navigation controls
            updateHistoryNavigation();
        }
        
        function renderReportHistoryList(reports, selectedReportId = null) {
            const listContainer = document.getElementById('history-reports-list');
            if (!listContainer) return;
            
            if (reports.length === 0) {
                listContainer.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-file-alt"></i>
                        <h3>No Reports Found</h3>
                        <p>No historical reports found for this report type</p>
                    </div>
                `;
                return;
            }
            
            const reportsHTML = reports.map((report, index) => {
                const isSelected = selectedReportId ? report.id == selectedReportId : index === 0;
                const uploadDate = report.created_at || report.date;
                const submitter = report.submitter || 'Unknown';
                const department = report.department || 'N/A';
                
                return `
                    <div class="history-report-item ${isSelected ? 'selected' : ''}" 
                         onclick="selectHistoryReport(${index})" 
                         style="padding: 15px; border: 1px solid #e9ecef; border-radius: 6px; margin-bottom: 10px; cursor: pointer; transition: background-color 0.2s; ${isSelected ? 'background-color: #e3f2fd; border-color: #2196f3;' : ''}"
                         onmouseover="this.style.backgroundColor='${isSelected ? '#e3f2fd' : '#f8f9fa'}'" 
                         onmouseout="this.style.backgroundColor='${isSelected ? '#e3f2fd' : 'white'}'">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                            <div style="font-weight: 600; color: #333; flex: 1;">${report.name}</div>
                            <div style="font-size: 0.8rem; color: #666; text-align: right;">
                                ${uploadDate ? new Date(uploadDate).toLocaleDateString() : 'N/A'}
                            </div>
                        </div>
                        <div style="font-size: 0.85rem; color: #666; margin-bottom: 5px;">
                            <i class="fas fa-user"></i> ${submitter} | <i class="fas fa-building"></i> ${department}
                        </div>
                        <div style="font-size: 0.8rem; color: #999;">
                            <i class="fas fa-file"></i> ${(() => {
                                const fileName = report.name || 'Unknown file';
                                let fileExtension = getFileExtension(fileName);
                                
                                // If no extension found in filename or if it's invalid, try to extract from URL
                                const fileUrl = report.report_url || report.fileURL;
                                if ((fileExtension === 'Unknown' || fileExtension.length > 4) && fileUrl && fileUrl.includes('/')) {
                                    const urlParts = fileUrl.split('/');
                                    const lastPart = decodeURIComponent(urlParts[urlParts.length - 1]);
                                    const urlExtensionMatch = lastPart.match(/\.([a-zA-Z0-9]+)$/);
                                    if (urlExtensionMatch) {
                                        fileExtension = urlExtensionMatch[1].toLowerCase();
                                    }
                                }
                                
                                return fileExtension.toUpperCase();
                            })()}
                        </div>
                    </div>
                `;
            }).join('');
            
            listContainer.innerHTML = reportsHTML;
        }
        
        function selectHistoryReport(index) {
            if (index < 0 || index >= currentHistoryReports.length) return;
            
            currentHistoryIndex = index;
            const report = currentHistoryReports[index];
            
            // Update selection in the list
            const reportItems = document.querySelectorAll('.history-report-item');
            reportItems.forEach((item, i) => {
                if (i === index) {
                    item.classList.add('selected');
                    item.style.backgroundColor = '#e3f2fd';
                    item.style.borderColor = '#2196f3';
                } else {
                    item.classList.remove('selected');
                    item.style.backgroundColor = 'white';
                    item.style.borderColor = '#e9ecef';
                }
            });
            
            // Preview the selected report
            previewHistoryReport(report);
            
            // Update navigation controls
            updateHistoryNavigation();
        }
        
        function previewHistoryReport(report) {
            console.log('👁️ Previewing history report:', report.name);
            
            const previewContainer = document.getElementById('history-preview-container');
            const previewTitle = document.getElementById('history-preview-title');
            const previewInfo = document.getElementById('history-preview-info');
            const previewImage = document.getElementById('history-preview-image');
            const noPreviewMessage = document.getElementById('history-no-preview-message');
            
            if (!previewContainer || !previewTitle || !previewInfo) return;
            
            // Clear existing content
            previewContainer.innerHTML = `
                <p id="history-no-preview-message" style="color: #999; font-style: italic;">Select a report to preview</p>
                <img id="history-preview-image" src="" alt="Report Preview" style="max-width: 100%; max-height: 100%; display: none;">
            `;
            
            // Re-get elements after clearing
            const newPreviewImage = document.getElementById('history-preview-image');
            const newNoPreviewMessage = document.getElementById('history-no-preview-message');
            
            // Handle both report_url and fileURL field names for compatibility
            const fileUrl = report.report_url || report.fileURL;
            
            if (!fileUrl) {
                previewContainer.innerHTML = `
                    <div style="text-align: center; color: #999;">
                        <i class="fas fa-file-alt" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                        <p>No file URL available for preview</p>
                    </div>
                `;
                previewTitle.textContent = 'Report Preview';
                previewInfo.textContent = '';
                return;
            }
            
            // Determine file type and create appropriate preview
            const fileName = report.name || 'Unknown file';
            let fileExtension = getFileExtension(fileName);
            
            // If no extension found in filename or if it's invalid, try to extract from URL
            if ((fileExtension === 'Unknown' || fileExtension.length > 4) && fileUrl.includes('/')) {
                console.log('🔍 Extension is invalid or unknown, checking URL...');
                const urlParts = fileUrl.split('/');
                const lastPart = decodeURIComponent(urlParts[urlParts.length - 1]);
                console.log('🔍 Decoded URL last part:', lastPart);
                const urlExtensionMatch = lastPart.match(/\.([a-zA-Z0-9]+)$/);
                if (urlExtensionMatch) {
                    fileExtension = urlExtensionMatch[1].toLowerCase();
                    console.log('🔍 Extracted extension from URL:', fileExtension);
                } else {
                    console.log('🔍 No extension found in URL');
                }
            }
            
            console.log('🔍 Detected file extension:', fileExtension);
            
            // Check if it's an image
            if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'].includes(fileExtension)) {
                console.log('🖼️ Loading image preview');
                const img = document.createElement('img');
                img.src = fileUrl;
                img.style.maxWidth = '100%';
                img.style.maxHeight = '100%';
                img.style.objectFit = 'contain';
                img.onload = () => {
                    if (newPreviewImage) {
                        newPreviewImage.src = fileUrl;
                        newPreviewImage.style.display = 'block';
                    }
                    previewTitle.textContent = `Preview: ${fileName}`;
                    previewInfo.textContent = `File: ${fileName} | Type: ${fileExtension.toUpperCase()}`;
                    if (newNoPreviewMessage) {
                        newNoPreviewMessage.style.display = 'none';
                    }
                };
                img.onerror = () => {
                    console.error('❌ Failed to load image');
                    showHistoryFileNotAccessiblePreview(previewContainer, fileName, fileUrl, 'image');
                };
                previewContainer.appendChild(img);
            }
            // Check if it's a PDF
            else if (fileExtension === 'pdf') {
                console.log('📄 Loading PDF preview');
                const iframe = document.createElement('iframe');
                iframe.src = fileUrl;
                iframe.style.width = '100%';
                iframe.style.height = '100%';
                iframe.style.border = 'none';
                iframe.onload = () => {
                    if (newPreviewImage) {
                        newPreviewImage.src = fileUrl;
                        newPreviewImage.style.display = 'block';
                    }
                    previewTitle.textContent = `Preview: ${fileName}`;
                    previewInfo.textContent = `File: ${fileName} | Type: ${fileExtension.toUpperCase()}`;
                    if (newNoPreviewMessage) {
                        newNoPreviewMessage.style.display = 'none';
                    }
                };
                iframe.onerror = () => {
                    console.error('❌ Failed to load PDF');
                    showHistoryFileNotAccessiblePreview(previewContainer, fileName, fileUrl, 'pdf');
                };
                previewContainer.appendChild(iframe);
            }
            // Check if it's a video
            else if (['mp4', 'webm', 'ogg', 'mov', 'avi'].includes(fileExtension)) {
                console.log('🎥 Loading video preview');
                previewContainer.innerHTML = '';
                
                const video = document.createElement('video');
                video.src = fileUrl;
                video.controls = true;
                video.style.maxWidth = '100%';
                video.style.maxHeight = '100%';
                video.style.width = 'auto';
                video.style.height = 'auto';
                video.style.objectFit = 'contain';
                video.style.display = 'block';
                
                video.addEventListener('loadedmetadata', () => {
                    previewTitle.textContent = `Preview: ${fileName}`;
                    previewInfo.textContent = `File: ${fileName} | Type: ${fileExtension.toUpperCase()}`;
                });
                
                video.addEventListener('error', (e) => {
                    console.error('❌ Failed to load video:', e);
                    showHistoryFileNotAccessiblePreview(previewContainer, fileName, fileUrl, 'video');
                });
                
                previewContainer.appendChild(video);
                previewTitle.textContent = `Preview: ${fileName}`;
                previewInfo.textContent = `File: ${fileName} | Type: ${fileExtension.toUpperCase()}`;
            }
            // Check if it's a document
            else if (['doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx', 'txt'].includes(fileExtension)) {
                console.log('📄 Loading document preview');
                
                if (['doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx'].includes(fileExtension)) {
                    const officeViewerUrl = `https://view.officeapps.live.com/op/embed.aspx?src=${encodeURIComponent(fileUrl)}&wdAllowInteractivity=False`;
                    
                    const iframe = document.createElement('iframe');
                    iframe.src = officeViewerUrl;
                    iframe.style.width = '100%';
                    iframe.style.height = '100%';
                    iframe.style.minHeight = '100%';
                    iframe.style.display = 'block';
                    iframe.style.border = 'none';
                    iframe.onload = () => {
                        if (newPreviewImage) {
                            newPreviewImage.src = fileUrl;
                            newPreviewImage.style.display = 'block';
                        }
                        previewTitle.textContent = `Preview: ${fileName}`;
                        previewInfo.textContent = `File: ${fileName} | Type: ${fileExtension.toUpperCase()}`;
                        if (newNoPreviewMessage) {
                            newNoPreviewMessage.style.display = 'none';
                        }
                    };
                    iframe.onerror = () => {
                        console.error('❌ Failed to load Office document');
                        showHistoryDocumentFallbackPreview(previewContainer, fileName, fileUrl, fileExtension);
                    };
                    previewContainer.appendChild(iframe);
                } else {
                    showHistoryDocumentFallbackPreview(previewContainer, fileName, fileUrl, fileExtension);
                }
            }
            // Default file preview
            else {
                console.log('📁 Showing generic file preview');
                previewContainer.innerHTML = `
                    <div style="text-align: center; color: #999;">
                        <i class="fas fa-file" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                        <p><strong>${fileName}</strong></p>
                        <p style="font-size: 0.8rem;">Preview not available for this file type</p>
                        <p style="font-size: 0.8rem;">Click download to access the file</p>
                        <p style="font-size: 0.8rem;">File type: ${fileExtension ? fileExtension.toUpperCase() : 'Unknown'}</p>
                        <p style="font-size: 0.8rem;">URL: ${fileUrl}</p>
                    </div>
                `;
                previewTitle.textContent = 'Report Preview';
                previewInfo.textContent = '';
            }
        }
        
        function clearHistoryPreview() {
            const previewContainer = document.getElementById('history-preview-container');
            const previewTitle = document.getElementById('history-preview-title');
            const previewInfo = document.getElementById('history-preview-info');
            
            if (previewContainer) {
                previewContainer.innerHTML = `
                    <p id="history-no-preview-message" style="color: #999; font-style: italic;">Select a report to preview</p>
                    <img id="history-preview-image" src="" alt="Report Preview" style="max-width: 100%; max-height: 100%; display: none;">
                `;
            }
            if (previewTitle) previewTitle.textContent = 'Report Preview';
            if (previewInfo) previewInfo.textContent = '';
        }
        
        function updateHistoryNavigation() {
            const prevBtn = document.getElementById('history-prev-report-btn');
            const nextBtn = document.getElementById('history-next-report-btn');
            const counter = document.getElementById('history-preview-counter');
            
            if (prevBtn) prevBtn.disabled = currentHistoryIndex <= 0;
            if (nextBtn) nextBtn.disabled = currentHistoryIndex >= currentHistoryReports.length - 1;
            if (counter) counter.textContent = `${currentHistoryIndex + 1} of ${currentHistoryReports.length}`;
        }
        
        function showHistoryFileNotAccessiblePreview(previewContainer, fileName, fileUrl, fileType) {
            previewContainer.innerHTML = `
                <div style="text-align: center; color: #999;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem; color: #ffc107;"></i>
                    <p><strong>${fileName}</strong></p>
                    <p style="font-size: 0.8rem;">File not accessible</p>
                    <p style="font-size: 0.8rem;">The file may have been moved or deleted</p>
                    <p style="font-size: 0.8rem;">File type: ${fileType}</p>
                    <p style="font-size: 0.8rem;">URL: ${fileUrl}</p>
                </div>
            `;
        }
        
        function showHistoryDocumentFallbackPreview(previewContainer, fileName, fileUrl, fileExtension) {
            previewContainer.innerHTML = `
                <div style="text-align: center; color: #999;">
                    <i class="fas fa-file-alt" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                    <p><strong>${fileName}</strong></p>
                    <p style="font-size: 0.8rem;">Document preview not available</p>
                    <p style="font-size: 0.8rem;">File type: ${fileExtension ? fileExtension.toUpperCase() : 'Unknown'}</p>
                    <a href="${fileUrl}" target="_blank" class="action-button primary" style="margin-top: 10px;">
                        <i class="fas fa-external-link-alt"></i> Open in New Tab
                    </a>
                </div>
            `;
        }
        
        function getFileExtension(fileName) {
            if (!fileName) return 'Unknown';
            
            // Use regex to find the actual file extension at the end of the filename
            const extensionMatch = fileName.match(/\.([a-zA-Z0-9]+)$/);
            if (extensionMatch) {
                return extensionMatch[1].toLowerCase();
            }
            
            // If no extension found in filename, try to extract from URL if available
            if (fileName.includes('http') || fileName.includes('/')) {
                const urlParts = fileName.split('/');
                const lastPart = urlParts[urlParts.length - 1];
                const urlExtensionMatch = lastPart.match(/\.([a-zA-Z0-9]+)$/);
                if (urlExtensionMatch) {
                    return urlExtensionMatch[1].toLowerCase();
                }
            }
            
            return 'Unknown';
        }
        
        function loadKpiEntries() {
            if (!currentScorecard) return;
            
            const kpis = DB.getKPIsByScorecard(currentScorecard.id);
            const kpiEntriesContainer = document.getElementById('kpi-entries');
            
            if (!kpiEntriesContainer) return;
            
            // Check access permissions
            const canEnter = canEnterKpiValues(currentScorecard);
            const canSubmit = canSubmitScorecard(currentScorecard);
            const canApprove = canApproveScorecard(currentScorecard);
            
            console.log('🔐 Access permissions:', { canEnter, canSubmit, canApprove });
            console.log('🔐 Current user:', DB.getCurrentUser());
            console.log('🔐 Scorecard department:', currentScorecard.department);
            console.log('🔐 Scorecard responsible person:', currentScorecard.responsible_person);
            
            // Check if scorecard is locked (approved)
            const existingResults = DB.get('scorecard_results') || [];
            const existingResult = existingResults.find(r => 
                r.scorecard_id === currentScorecard.id && 
                r.period_month === currentPeriod.month && 
                r.period_year === currentPeriod.year
            );
            const isLocked = isScorecardLocked(existingResult);
            
            console.log('🔒 Scorecard locked:', isLocked);
            console.log('🔒 Existing result:', existingResult);
            console.log('🔒 Current period:', currentPeriod);
            
            kpiEntriesContainer.innerHTML = '';
            
            if (!canEnter && !canSubmit && !canApprove) {
                // User has no permissions - show access denied message
                const currentUser = DB.getCurrentUser();
                const departments = DB.get('departments') || [];
                const department = departments.find(dept => dept.name === currentScorecard.department);
                
                kpiEntriesContainer.innerHTML = `
                    <div class="access-denied-message" style="text-align: center; padding: 2rem; color: #666;">
                        <i class="fas fa-lock" style="font-size: 3rem; margin-bottom: 1rem; color: #999;"></i>
                        <h3>Access Denied</h3>
                        <p>You do not have permission to view or edit this scorecard.</p>
                        <p><strong>Current User:</strong> ${currentUser ? currentUser.name : 'Unknown'} (${currentUser ? currentUser.role : 'No role'})</p>
                        <p><strong>Scorecard Department:</strong> ${currentScorecard.department}</p>
                        <p><strong>Department Manager:</strong> ${department ? department.manager : 'Not found'}</p>
                        <p><strong>Responsible Person:</strong> ${currentScorecard.responsible_person}</p>
                        <p><strong>Required:</strong> You must be either the responsible person, department manager, or HR manager for this scorecard.</p>
                    </div>
                `;
                updateButtonVisibility(false, false, false, isLocked);
                return;
            }
            
            if (isLocked) {
                // Scorecard is approved and locked - show read-only view
                kpiEntriesContainer.innerHTML = `
                    <div class="locked-message" style="text-align: center; padding: 1rem; background: #f8f9fa; border-radius: 8px; margin-bottom: 1rem;">
                        <i class="fas fa-check-circle" style="color: #28a745; margin-right: 0.5rem;"></i>
                        <strong>Scorecard Approved</strong> - This scorecard has been approved and is locked for editing.
                    </div>
                `;
            }
                
            kpis.forEach(kpi => {
                const kpiEntry = document.createElement('div');
                kpiEntry.className = 'kpi-entry-item';
                
                const inputDisabled = !canEnter || isLocked;
                console.log(`🔧 KPI ${kpi.id} input disabled:`, { canEnter, isLocked, inputDisabled });
                
                kpiEntry.innerHTML = `
                    <div class="kpi-info">
                        <div class="kpi-name">${kpi.name}</div>
                        <div class="kpi-details">Weight: ${kpi.weight}% | Unit: ${kpi.unit}</div>
                    </div>
                    <div class="kpi-target">${kpi.target} ${kpi.unit}</div>
                        <input type="number" 
                               id="kpi-input-${kpi.id}" 
                               class="kpi-input" 
                               placeholder="Enter value"
                               onchange="updateKpiValue(${kpi.id}, this.value)"
                           ${inputDisabled ? 'disabled' : ''}>
                    <div class="kpi-performance" id="kpi-performance-${kpi.id}">
                        <span>--</span>
                    </div>
                `;
                kpiEntriesContainer.appendChild(kpiEntry);
            });
            
            // Update button visibility based on permissions and lock status
            updateButtonVisibility(canEnter, canSubmit, canApprove, isLocked);
            
            console.log(`✅ Loaded ${kpis.length} KPI entries with access control`);
        }
        
        function updateKpiValue(kpiId, value) {
            // Check if scorecard is locked
            if (currentScorecard) {
                const existingResults = DB.get('scorecard_results') || [];
                const existingResult = existingResults.find(r => 
                    r.scorecard_id === currentScorecard.id && 
                    r.period_month === currentPeriod.month && 
                    r.period_year === currentPeriod.year
                );
                
                if (isScorecardLocked(existingResult)) {
                    console.log('🔒 Scorecard is locked, cannot update KPI values');
                    return;
                }
            }
            
            const numValue = parseFloat(value);
            currentKpiData[kpiId] = isNaN(numValue) ? null : numValue;
            
            const kpi = DB.getById('kpis', kpiId);
            if (kpi) {
                updateKpiPerformance(kpiId, numValue, kpi);
            }
            
            updatePerformanceResults();
        }
                
        function updateKpiPerformance(kpiId, value, kpi) {
            const performanceElement = document.getElementById(`kpi-performance-${kpiId}`);
            if (!performanceElement) return;
            
            if (value === null || isNaN(value)) {
                performanceElement.innerHTML = '<span>--</span>';
                performanceElement.className = 'kpi-performance performance-unknown';
                return;
            }
            
            const percentage = (value / kpi.target) * 100;
            let performanceClass = 'performance-below';
            let performanceText = `${percentage.toFixed(1)}%`;
            
            if (percentage >= 100) {
                performanceClass = 'performance-above';
                performanceText = `${percentage.toFixed(1)}% ✓`;
            } else if (percentage >= 90) {
                performanceClass = 'performance-on-target';
                performanceText = `${percentage.toFixed(1)}% ~`;
            }
            
            performanceElement.innerHTML = `<span>${performanceText}</span>`;
            performanceElement.className = `kpi-performance ${performanceClass}`;
        }
        
        function loadPeriodData() {
            console.log('🔄 loadPeriodData() called');
            console.log(`📊 Current scorecard:`, currentScorecard);
            console.log(`📅 Current period:`, currentPeriod);
            
            if (!currentScorecard) {
                console.warn('⚠️ No scorecard selected, but will still refresh UI');
                clearKpiForm();
                return;
            }
            
            // Load existing data for current period
            const existingResults = DB.get('scorecard_results') || [];
            console.log(`📋 Found ${existingResults.length} existing scorecard results`);
            
            const existingResult = existingResults.find(r => 
                r.scorecard_id === currentScorecard.id && 
                r.period_month === currentPeriod.month && 
                r.period_year === currentPeriod.year
            );
            
            if (existingResult) {
                console.log(`✅ Found existing data for period ${currentPeriod.month}/${currentPeriod.year}:`, existingResult);
                currentKpiData = { ...existingResult.kpi_values };
                
                // Populate form fields
                Object.keys(currentKpiData).forEach(kpiId => {
                    const input = document.getElementById(`kpi-input-${kpiId}`);
                    if (input) {
                        input.value = currentKpiData[kpiId];
                        console.log(`📝 Populated KPI ${kpiId} with value:`, currentKpiData[kpiId]);
                        
                        const kpi = DB.getById('kpis', parseInt(kpiId));
                        if (kpi) {
                            updateKpiPerformance(parseInt(kpiId), currentKpiData[kpiId], kpi);
                        }
                    } else {
                        console.warn(`⚠️ Could not find input field for KPI ${kpiId}`);
                    }
                });
                
                updatePerformanceResults();
                updateStatusDisplay(existingResult);
                console.log('✅ KPI form populated with existing data');
            } else {
                console.log(`📝 No existing data found for period ${currentPeriod.month}/${currentPeriod.year}, clearing form`);
                clearKpiForm();
                updateStatusDisplay(null);
            }
        }
        
        function clearKpiForm() {
            console.log('🧹 Clearing KPI form...');
            
                currentKpiData = {};
                const inputs = document.querySelectorAll('.kpi-input');
            console.log(`📝 Clearing ${inputs.length} KPI input fields`);
            
                inputs.forEach(input => {
                    input.value = '';
                });
                
                const performances = document.querySelectorAll('.kpi-performance');
            console.log(`📊 Resetting ${performances.length} performance indicators`);
            
                performances.forEach(perf => {
                    perf.innerHTML = '<span>--</span>';
                    perf.className = 'kpi-performance performance-unknown';
                });
                
            // Hide performance summary
            const performanceSummary = document.getElementById('performance-summary');
            if (performanceSummary) {
                performanceSummary.style.display = 'none';
            }
            
            console.log('✅ KPI form cleared successfully');
        }
        
        function updatePeriodDisplay() {
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            const display = document.getElementById('current-period');
            if (display) {
                display.textContent = `${monthNames[currentPeriod.month - 1]} ${currentPeriod.year}`;
            }
        }
        
        function onPeriodChange() {
            console.log('🔄 onPeriodChange() called');
            
            const month = document.getElementById('period-month').value;
            const year = document.getElementById('period-year').value;
            console.log(`📅 Period changed to: Month ${month}, Year ${year}`);
            
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            const display = document.getElementById('current-period');
            if (display) {
                display.textContent = `${monthNames[month - 1]} ${year}`;
                console.log(`✅ Updated period display to: ${monthNames[month - 1]} ${year}`);
            } else {
                console.warn('⚠️ Could not find current-period display element');
            }
            
            // Update currentPeriod object
            currentPeriod = { month: parseInt(month), year: parseInt(year) };
            console.log(`📊 Updated currentPeriod object:`, currentPeriod);
            
            // Load KPI values for the selected period
            loadPeriodData();
        }
        
        function updatePerformanceResults() {
            console.log('🔄 updatePerformanceResults() called');
            
            if (!currentScorecard) {
                console.warn('⚠️ No scorecard selected, cannot update performance results');
                return;
            }
            
            const kpis = DB.getKPIsByScorecard(currentScorecard.id);
            console.log(`📊 Processing ${kpis.length} KPIs for performance calculation`);
            
            let totalScore = 0;
            let totalWeight = 0;
            let kpisWithData = 0;
            let onTarget = 0;
            let belowTarget = 0;
            let aboveTarget = 0;
            
            kpis.forEach(kpi => {
                const value = currentKpiData[kpi.id];
                if (value !== null && !isNaN(value)) {
                    kpisWithData++;
                    const percentage = (value / kpi.target) * 100;
                    const weightedScore = (percentage * kpi.weight) / 100;
                    totalScore += weightedScore;
                    totalWeight += kpi.weight;
                    
                    console.log(`📈 KPI ${kpi.name}: Value=${value}, Target=${kpi.target}, Performance=${percentage.toFixed(1)}%`);
                    
                    if (percentage >= 100) {
                        aboveTarget++;
                    } else if (percentage >= 90) {
                        onTarget++;
                    } else {
                        belowTarget++;
                    }
                } else {
                    console.log(`📊 KPI ${kpi.name}: No data available`);
                }
            });
            
            const overallScore = totalWeight > 0 ? (totalScore / totalWeight) * 100 : 0;
            console.log(`🎯 Overall Score: ${overallScore.toFixed(1)}% (${kpisWithData}/${kpis.length} KPIs with data)`);
            
            // Update display in the performance summary
            const overallScoreElement = document.getElementById('overall-score');
            const kpisWithDataElement = document.getElementById('kpis-with-data');
            const onTargetElement = document.getElementById('on-target-count');
            const belowTargetElement = document.getElementById('below-target-count');
            const aboveTargetElement = document.getElementById('above-target-count');
            
            if (overallScoreElement) overallScoreElement.textContent = overallScore.toFixed(1);
            if (kpisWithDataElement) kpisWithDataElement.textContent = `${kpisWithData}/${kpis.length}`;
            if (onTargetElement) onTargetElement.textContent = onTarget;
            if (belowTargetElement) belowTargetElement.textContent = belowTarget;
            if (aboveTargetElement) aboveTargetElement.textContent = aboveTarget;
            
            // Show the performance summary
            const performanceSummary = document.getElementById('performance-summary');
            if (performanceSummary) {
                performanceSummary.style.display = 'block';
            }
            
            console.log('✅ Performance results updated successfully');
        }
        
        function clearScorecard() {
            currentScorecard = null;
            currentKpiData = {};
            
            // Reset the inline history title
            const titleElement = document.getElementById('inline-history-title');
            if (titleElement) titleElement.textContent = 'Scorecard History Report';
            
            // Clear inline history report
            initializeInlineHistoryReport();
            
            // Clear related reports
            clearRelatedReports();
            
            console.log('🧹 Scorecard cleared');
        }
        
        function clearRelatedReports() {
            console.log('🧹 Clearing related reports');
            
            const relatedReportsTable = document.getElementById('related-reports-table');
            if (relatedReportsTable) {
                const tbody = relatedReportsTable.querySelector('tbody');
                if (tbody) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; color: #999; font-style: italic;">
                                Select a scorecard to view related reports
                            </td>
                        </tr>
                    `;
                }
            }
            
            // Clear preview pane
            const previewTitle = document.getElementById('preview-title');
            const previewInfo = document.getElementById('preview-info');
            const previewContainer = document.getElementById('preview-container');
            
            if (previewTitle) previewTitle.textContent = 'Report Preview';
            if (previewInfo) previewInfo.textContent = '';
            if (previewContainer) {
                previewContainer.innerHTML = `
                    <p id="no-preview-message" style="color: #999; font-style: italic;">Select a report to preview</p>
                    <img id="preview-image" src="" alt="Report Preview" style="max-width: 100%; max-height: 400px; display: none;">
                `;
            }
        }
        
        function initializeRelatedReports() {
            console.log('🔧 Initializing related reports table');
            clearRelatedReports();
        }
        
        function filterScorecards() {
            const departmentFilter = document.getElementById('department-filter');
            const scorecardFilter = document.getElementById('scorecard-filter');
            
            if (!departmentFilter || !scorecardFilter) return;
            
            const selectedDepartment = departmentFilter.value;
            const scorecards = DB.get('scorecards') || [];
            
            // Clear existing options
            scorecardFilter.innerHTML = '<option value="">Select Scorecard</option>';
            
            // Filter scorecards by department
            const filteredScorecards = selectedDepartment 
                ? scorecards.filter(sc => sc.department === selectedDepartment)
                : scorecards;
            
            // Add filtered scorecard options
            filteredScorecards.forEach(scorecard => {
                const option = document.createElement('option');
                option.value = scorecard.id;
                option.textContent = `${scorecard.name} (${scorecard.department})`;
                scorecardFilter.appendChild(option);
            });
            
            console.log(`✅ Filtered scorecards: ${filteredScorecards.length} for department: ${selectedDepartment || 'All'}`);
        }
        
        function calculatePeriodPerformance(periodValue) {
            // This function would calculate performance for the selected period
            console.log('📊 Calculating performance for period:', periodValue);
            // Implementation would depend on the period format (Q1, Summer, etc.)
        }
        
        function updateAutoSaveIndicator(status) {
            const indicator = document.getElementById('auto-save-indicator');
            if (!indicator) return;
            
            const icon = indicator.querySelector('i');
            const text = indicator.querySelector('span');
            
            indicator.className = `auto-save-indicator ${status}`;
            
            switch (status) {
                case 'saving':
                    icon.className = 'fas fa-spinner fa-spin';
                    text.textContent = 'Saving...';
                    break;
                case 'saved':
                    icon.className = 'fas fa-check-circle';
                    text.textContent = 'Auto-saved';
                    break;
                case 'error':
                    icon.className = 'fas fa-exclamation-circle';
                    text.textContent = 'Save failed';
                    break;
                default:
                    icon.className = 'fas fa-circle';
                    text.textContent = 'Ready to save';
            }
        }
        
        function saveKpiData() {
            if (!currentScorecard) {
                alert('Please select a scorecard first');
                return;
            }
            
            console.log('💾 Saving KPI data...');
            console.log('📊 Current KPI data:', currentKpiData);
            console.log('📅 Current period:', currentPeriod);
            
            // Check if we have any data to save
            const kpis = DB.getKPIsByScorecard(currentScorecard.id);
            const kpiValues = {};
            let hasData = false;
            
            kpis.forEach(kpi => {
                const value = currentKpiData[kpi.id];
                if (value !== null && !isNaN(value)) {
                    kpiValues[kpi.id] = value;
                    hasData = true;
                }
            });
            
            if (!hasData) {
                alert('Please enter at least one KPI value');
                return;
            }
            
            try {
                // Calculate overall score
                let totalScore = 0;
                let totalWeight = 0;
                
                kpis.forEach(kpi => {
                    const value = kpiValues[kpi.id];
                    if (value !== null && !isNaN(value)) {
                        const percentage = (value / kpi.target) * 100;
                        const weightedScore = (percentage * kpi.weight) / 100;
                        totalScore += weightedScore;
                        totalWeight += kpi.weight;
                    }
                });
                
                const overallScore = totalWeight > 0 ? (totalScore / totalWeight) * 100 : 0;
                
                // Save to database
                const resultData = {
                    scorecard_id: currentScorecard.id,
                    user_id: DB.getCurrentUser()?.id || 1,
                    period_month: currentPeriod.month,
                    period_year: currentPeriod.year,
                    kpi_values: kpiValues,
                    total_score: overallScore,
                    status: 'draft',
                    is_auto_save: false
                };
                
                // Check if result already exists
                const existingResults = DB.get('scorecard_results') || [];
                const existingResult = existingResults.find(r => 
                r.scorecard_id === currentScorecard.id && 
                r.period_month === currentPeriod.month && 
                r.period_year === currentPeriod.year
            );
            
            if (existingResult) {
                    // Update existing result
                    console.log('📝 Updating existing result:', existingResult.id);
                    // Preserve existing status unless we're explicitly setting it to draft
                    const currentStatus = existingResult.status;
                    Object.assign(existingResult, resultData);
                    // Only update status to draft if it was previously draft or if no status exists
                    if (currentStatus && currentStatus !== 'draft') {
                        existingResult.status = currentStatus;
                    }
                DB.update('scorecard_results', existingResult.id, existingResult);
                    console.log('✅ Updated existing scorecard result');
            } else {
                    // Create new result
                    console.log('🆕 Creating new result');
                    const addedResult = DB.add('scorecard_results', resultData);
                    console.log('✅ Created new scorecard result:', addedResult);
                }
                
                // Sync to Supabase if available
                if (typeof supabaseIntegrationManager !== 'undefined') {
                    console.log('🔄 Syncing to Supabase...');
                    updateAutoSaveIndicator('saving');
                    supabaseIntegrationManager.syncToSupabase()
                        .then(() => {
                            console.log('✅ KPI data synced to Supabase');
                            updateAutoSaveIndicator('saved');
                            updatePerformanceResults();
                            
                            // Refresh inline history report to show correct status
                            if (currentScorecard) {
                                generateInlineHistoryReport();
                            }
                            
                            // Show success message
                            const successMessage = document.createElement('div');
                            successMessage.style.cssText = `
                                position: fixed;
                                top: 20px;
                                right: 20px;
                                background: #28a745;
                                color: white;
                                padding: 15px 20px;
                                border-radius: 5px;
                                box-shadow: 0 4px 8px rgba(0,0,0,0.2);
                                z-index: 10000;
                                font-weight: 500;
                            `;
                            successMessage.innerHTML = '<i class="fas fa-check"></i> KPI data saved and synced successfully!';
                            document.body.appendChild(successMessage);
                            
                            // Remove after 3 seconds
                            setTimeout(() => {
                                if (successMessage.parentNode) {
                                    successMessage.parentNode.removeChild(successMessage);
                                }
                            }, 3000);
                            
                            console.log('✅ Success toast notification displayed');
                        })
                        .catch((error) => {
                            console.warn('⚠️ Supabase sync failed:', error);
                            updateAutoSaveIndicator('error');
                            
                            // Show warning message
                            const warningMessage = document.createElement('div');
                            warningMessage.style.cssText = `
                                position: fixed;
                                top: 20px;
                                right: 20px;
                                background: #ffc107;
                                color: #333;
                                padding: 15px 20px;
                                border-radius: 5px;
                                box-shadow: 0 4px 8px rgba(0,0,0,0.2);
                                z-index: 10000;
                                font-weight: 500;
                            `;
                            warningMessage.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Saved locally but sync failed';
                            document.body.appendChild(warningMessage);
                            
                            // Remove after 3 seconds
                            setTimeout(() => {
                                if (warningMessage.parentNode) {
                                    warningMessage.parentNode.removeChild(warningMessage);
                                }
                            }, 3000);
                        });
                } else {
                    console.log('⚠️ Supabase integration not available, saved locally only');
                    updateAutoSaveIndicator('saved');
                    updatePerformanceResults();
                    
                    // Refresh inline history report to show correct status
                    if (currentScorecard) {
                        generateInlineHistoryReport();
                    }
                    
                    // Show local save message
                    const successMessage = document.createElement('div');
                    successMessage.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #28a745;
                        color: white;
                        padding: 15px 20px;
                        border-radius: 5px;
                        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
                        z-index: 10000;
                        font-weight: 500;
                    `;
                    successMessage.innerHTML = '<i class="fas fa-check"></i> KPI data saved locally!';
                    document.body.appendChild(successMessage);
                    
                    // Remove after 3 seconds
                    setTimeout(() => {
                        if (successMessage.parentNode) {
                            successMessage.parentNode.removeChild(successMessage);
                        }
                    }, 3000);
                }
                
            } catch (error) {
                console.error('❌ Error saving KPI data:', error);
                
                // Show error message
                const errorMessage = document.createElement('div');
                errorMessage.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #dc3545;
                    color: white;
                    padding: 15px 20px;
                    border-radius: 5px;
                    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
                    z-index: 10000;
                    font-weight: 500;
                `;
                errorMessage.innerHTML = '<i class="fas fa-times"></i> Error saving KPI data';
                document.body.appendChild(errorMessage);
                
                // Remove after 3 seconds
                setTimeout(() => {
                    if (errorMessage.parentNode) {
                        errorMessage.parentNode.removeChild(errorMessage);
                    }
                }, 3000);
            }
        }
        
        function resetKpiData() {
            if (confirm('Are you sure you want to reset all KPI values?')) {
                clearKpiForm();
                alert('KPI data reset successfully!');
            }
        }
        
        function viewHistory() {
            if (!currentScorecard) {
                alert('Please select a scorecard first');
                return;
            }
            
            const modal = document.getElementById('history-modal');
            const content = document.getElementById('history-content');
            
            // Load historical data
            const results = DB.get('scorecard_results') || [];
            const scorecardResults = results.filter(r => r.scorecard_id === currentScorecard.id);
            
            if (scorecardResults.length === 0) {
                content.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-history"></i>
                        <h3>No Historical Data</h3>
                        <p>No previous KPI data found for this scorecard.</p>
                    </div>
                `;
            } else {
                // Sort by period
                scorecardResults.sort((a, b) => {
                    if (a.period_year !== b.period_year) {
                        return b.period_year - a.period_year;
                    }
                    return b.period_month - a.period_month;
                });
                
                const monthNames = [
                    'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                    'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'
                ];
                
                content.innerHTML = `
                    <h4>Performance History for ${currentScorecard.name}</h4>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Period</th>
                                    <th>Overall Score</th>
                                    <th>KPIs with Data</th>
                                    <th>Status</th>
                                    <th>Submitted</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${scorecardResults.map(result => `
                                    <tr>
                                        <td>${monthNames[result.period_month - 1]} ${result.period_year}</td>
                                        <td>${result.total_score.toFixed(1)}%</td>
                                        <td>${Object.keys(result.kpi_values).length}</td>
                                        <td>${result.submitted_at ? 'Submitted' : 'Draft'}</td>
                                        <td>${result.submitted_at ? new Date(result.submitted_at).toLocaleDateString() : 'Not submitted'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            modal.style.display = 'block';
        }
        
        function exportResults() {
            if (!currentScorecard) {
                alert('Please select a scorecard first');
                return;
            }
            
            const kpis = DB.getKPIsByScorecard(currentScorecard.id);
            const monthNames = [
                'January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'
            ];
            
            let csvContent = 'data:text/csv;charset=utf-8,';
            csvContent += 'KPI Name,Target,Actual Value,Performance %,Weight,Unit\n';
            
            kpis.forEach(kpi => {
                const value = currentKpiData[kpi.id];
                const performance = value !== null && !isNaN(value) ? ((value / kpi.target) * 100).toFixed(1) : '--';
                const actualValue = value !== null && !isNaN(value) ? value : '--';
                
                csvContent += `"${kpi.name}",${kpi.target},${actualValue},${performance}%,${kpi.weight}%,${kpi.unit}\n`;
            });
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement('a');
            link.setAttribute('href', encodedUri);
            link.setAttribute('download', `${currentScorecard.name}_${monthNames[currentPeriod.month - 1]}_${currentPeriod.year}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function closeModals() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.style.display = 'none';
            });
        }
        
        // History Report Functions
        let currentHistoryData = null;
        let currentHistoryFilters = { periodType: 'month', year: 'all' };
        let inlineHistoryData = null;
        let inlineHistoryFilters = { periodType: 'month', year: 'all' };
        
        function openScorecardHistoryModal() {
            if (!currentScorecard) {
                alert('Please select a scorecard first');
                return;
            }
            
            const modal = document.getElementById('scorecard-history-modal');
            const content = document.getElementById('history-report-content');
            
            // Initialize filters
            initializeHistoryFilters();
            
            // Load and display the comprehensive history report
            generateHistoryReport(content);
            
            modal.style.display = 'block';
        }
        
        // Inline History Report Functions
        function initializeInlineHistoryReport() {
            if (!currentScorecard) {
                const content = document.getElementById('inline-history-content');
                if (content) {
                    content.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-chart-line"></i>
                            <h3>No Scorecard Selected</h3>
                            <p>Select a scorecard from the dropdown above to view history report</p>
                        </div>
                    `;
                }
                return;
            }
            
            // Initialize filters
            initializeInlineHistoryFilters();
            
            // Load and display the inline history report
            generateInlineHistoryReport();
        }
        
        function initializeInlineHistoryFilters() {
            // Get all historical data for this scorecard
            const results = DB.get('scorecard_results') || [];
            const scorecardResults = results.filter(r => r.scorecard_id === currentScorecard.id);
            
            // Populate year filter
            const yearFilter = document.getElementById('inline-history-year-filter');
            if (yearFilter) {
                yearFilter.innerHTML = '<option value="all">All Years</option>';
                
                const years = [...new Set(scorecardResults.map(r => r.period_year))].sort((a, b) => b - a);
                years.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    yearFilter.appendChild(option);
                });
            }
            
            // Store the original data
            inlineHistoryData = scorecardResults;
        }
        
        function updateInlineHistoryFilters() {
            const periodFilter = document.getElementById('inline-history-period-filter');
            const yearFilter = document.getElementById('inline-history-year-filter');
            
            if (periodFilter && yearFilter) {
                inlineHistoryFilters.periodType = periodFilter.value;
                inlineHistoryFilters.year = yearFilter.value;
            }
        }
        
        function applyInlineHistoryFilters() {
            updateInlineHistoryFilters();
            generateInlineHistoryReport();
        }
        
        function generateInlineHistoryReport() {
            if (!currentScorecard || !inlineHistoryData) return;
            
            const content = document.getElementById('inline-history-content');
            if (!content) return;
            
            // Apply filters to the data
            let filteredResults = applyFiltersToInlineData(inlineHistoryData);
            
            if (filteredResults.length === 0) {
                content.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-chart-line" style="font-size: 3rem; color: #ddd; margin-bottom: 20px;"></i>
                        <h3>No Data Found</h3>
                        <p>No data found for the selected filters.</p>
                    </div>
                    
                    <div class="add-report-section" style="margin-top: 30px; background: #f8f9fa; border-radius: 8px; padding: 20px; border: 1px solid #e9ecef;">
                        <h4><i class="fas fa-plus-circle"></i> Add New KPI Report</h4>
                        <p style="margin-bottom: 15px; color: #666;">Add KPI data for months that don't have existing data</p>
                        <div class="add-report-controls">
                            <div class="period-selector" style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px; flex-wrap: wrap;">
                                <div class="filter-group">
                                    <label for="inline-new-report-month" style="font-weight: 500; margin-bottom: 5px; display: block;">Month:</label>
                                    <select id="inline-new-report-month" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="1">January</option>
                                        <option value="2">February</option>
                                        <option value="3">March</option>
                                        <option value="4">April</option>
                                        <option value="5">May</option>
                                        <option value="6">June</option>
                                        <option value="7">July</option>
                                        <option value="8">August</option>
                                        <option value="9">September</option>
                                        <option value="10">October</option>
                                        <option value="11">November</option>
                                        <option value="12">December</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label for="inline-new-report-year" style="font-weight: 500; margin-bottom: 5px; display: block;">Year:</label>
                                    <select id="inline-new-report-year" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="2024">2024</option>
                                        <option value="2025">2025</option>
                                        <option value="2026">2026</option>
                                    </select>
                                </div>
                                <div class="filter-group" style="margin-top: 20px;">
                                    <button onclick="addNewKpiReportInline()" style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                                        <i class="fas fa-plus"></i> Add Report
                                    </button>
                                </div>
                            </div>
                            <div id="inline-new-report-status" style="font-size: 0.9rem; color: #666; margin-top: 10px;"></div>
                        </div>
                    </div>
                `;
                return;
            }
            
            // Sort by period (newest first)
            filteredResults.sort((a, b) => {
                if (a.period_year !== b.period_year) {
                    return b.period_year - a.period_year;
                }
                return b.period_month - a.period_month;
            });
            
            // Calculate statistics
            const stats = calculateHistoryStats(filteredResults);
            
            // Generate the comprehensive report
            content.innerHTML = `
                <div class="history-report-header">
                    <div class="history-report-title">${currentScorecard.name}</div>
                    <div class="history-report-subtitle">Comprehensive Performance History Report - ${getInlineFilterDisplayName()}</div>
                </div>
                
                <div class="history-stats-grid">
                    <div class="history-stat-card">
                        <div class="history-stat-value">${filteredResults.length}</div>
                        <div class="history-stat-label">Total Periods</div>
                    </div>
                    <div class="history-stat-card">
                        <div class="history-stat-value">${stats.averageScore.toFixed(1)}%</div>
                        <div class="history-stat-label">Average Score</div>
                    </div>
                    <div class="history-stat-card">
                        <div class="history-stat-value">${stats.bestScore.toFixed(1)}%</div>
                        <div class="history-stat-label">Best Performance</div>
                    </div>
                    <div class="history-stat-card">
                        <div class="history-stat-value">${stats.submittedCount}</div>
                        <div class="history-stat-label">Submitted</div>
                    </div>
                    <div class="history-stat-card">
                        <div class="history-stat-value">${stats.approvedCount}</div>
                        <div class="history-stat-label">Approved</div>
                    </div>
                    <div class="history-stat-card">
                        <div class="history-stat-value">${stats.trend}</div>
                        <div class="history-stat-label">Performance Trend</div>
                    </div>
                </div>
                
                <div class="history-timeline">
                    <h4><i class="fas fa-history"></i> Performance Timeline</h4>
                    ${generateTimelineHTML(filteredResults)}
                </div>
                
                <div class="performance-chart">
                    <h4><i class="fas fa-chart-bar"></i> Performance Chart</h4>
                    <div class="chart-container">
                        ${generatePerformanceChartHTML(filteredResults)}
                    </div>
                </div>
                
                <div class="kpi-breakdown">
                    <h4><i class="fas fa-list-ul"></i> KPI Performance Breakdown</h4>
                    ${generateKPIBreakdownHTML(filteredResults)}
                </div>
                
                <div class="export-section">
                    <h4><i class="fas fa-download"></i> Export Report</h4>
                    <p>Download this comprehensive report in your preferred format</p>
                    <div class="export-buttons">
                        <button class="export-btn pdf" onclick="exportHistoryReport('pdf')">
                            <i class="fas fa-file-pdf"></i> Export as PDF
                        </button>
                        <button class="export-btn excel" onclick="exportHistoryReport('excel')">
                            <i class="fas fa-file-excel"></i> Export as Excel
                        </button>
                    </div>
                </div>
                
                <div class="add-report-section">
                    <h4><i class="fas fa-plus-circle"></i> Add New KPI Report</h4>
                    <p>Add KPI data for months that don't have existing data</p>
                    <div class="add-report-controls">
                        <div class="period-selector" style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px;">
                            <div class="filter-group">
                                <label for="inline-new-report-month" style="font-weight: 500; margin-bottom: 5px; display: block;">Month:</label>
                                <select id="inline-new-report-month" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="1">January</option>
                                    <option value="2">February</option>
                                    <option value="3">March</option>
                                    <option value="4">April</option>
                                    <option value="5">May</option>
                                    <option value="6">June</option>
                                    <option value="7">July</option>
                                    <option value="8">August</option>
                                    <option value="9">September</option>
                                    <option value="10">October</option>
                                    <option value="11">November</option>
                                    <option value="12">December</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="inline-new-report-year" style="font-weight: 500; margin-bottom: 5px; display: block;">Year:</label>
                                <select id="inline-new-report-year" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="2024">2024</option>
                                    <option value="2025">2025</option>
                                    <option value="2026">2026</option>
                                </select>
                            </div>
                            <div class="filter-group" style="margin-top: 20px;">
                                <button onclick="addNewKpiReportInline()" style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                                    <i class="fas fa-plus"></i> Add Report
                                </button>
                            </div>
                        </div>
                        <div id="inline-new-report-status" style="font-size: 0.9rem; color: #666; margin-top: 10px;"></div>
                    </div>
                </div>
            `;
        }
        
        function applyFiltersToInlineData(data) {
            let filteredData = [...data];
            
            // Apply year filter
            if (inlineHistoryFilters.year !== 'all') {
                filteredData = filteredData.filter(r => r.period_year == inlineHistoryFilters.year);
            }
            
            // Apply period type filter
            if (inlineHistoryFilters.periodType === 'quarter') {
                filteredData = groupDataByQuarter(filteredData);
            } else if (inlineHistoryFilters.periodType === 'season') {
                filteredData = groupDataBySeason(filteredData);
            } else if (inlineHistoryFilters.periodType === 'year') {
                filteredData = groupDataByYear(filteredData);
            }
            // For 'month', keep as is
            
            return filteredData;
        }
        
        function getInlineFilterDisplayName() {
            const periodNames = {
                'month': 'Monthly',
                'quarter': 'Quarterly',
                'season': 'Seasonal',
                'year': 'Yearly'
            };
            
            const yearText = inlineHistoryFilters.year === 'all' ? 'All Years' : inlineHistoryFilters.year;
            return `${periodNames[inlineHistoryFilters.periodType]} - ${yearText}`;
        }
        
        function initializeHistoryFilters() {
            // Get all historical data for this scorecard
            const results = DB.get('scorecard_results') || [];
            const scorecardResults = results.filter(r => r.scorecard_id === currentScorecard.id);
            
            // Populate year filter
            const yearFilter = document.getElementById('history-year-filter');
            if (yearFilter) {
                yearFilter.innerHTML = '<option value="all">All Years</option>';
                
                const years = [...new Set(scorecardResults.map(r => r.period_year))].sort((a, b) => b - a);
                years.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    yearFilter.appendChild(option);
                });
            }
            
            // Store the original data
            currentHistoryData = scorecardResults;
        }
        
        function updateHistoryFilters() {
            const periodFilter = document.getElementById('history-period-filter');
            const yearFilter = document.getElementById('history-year-filter');
            
            if (periodFilter && yearFilter) {
                currentHistoryFilters.periodType = periodFilter.value;
                currentHistoryFilters.year = yearFilter.value;
            }
        }
        
        function applyHistoryFilters() {
            updateHistoryFilters();
            const content = document.getElementById('history-report-content');
            generateHistoryReport(content);
        }
        
        function generateHistoryReport(contentElement) {
            if (!currentScorecard || !currentHistoryData) return;
            
            // Apply filters to the data
            let filteredResults = applyFiltersToData(currentHistoryData);
            
            if (filteredResults.length === 0) {
                contentElement.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-chart-line" style="font-size: 3rem; color: #ddd; margin-bottom: 20px;"></i>
                        <h3>No Data Found</h3>
                        <p>No data found for the selected filters.</p>
                    </div>
                    
                    <div class="add-report-section" style="margin-top: 30px; background: #f8f9fa; border-radius: 8px; padding: 20px; border: 1px solid #e9ecef;">
                        <h4><i class="fas fa-plus-circle"></i> Add New KPI Report</h4>
                        <p style="margin-bottom: 15px; color: #666;">Add KPI data for months that don't have existing data</p>
                        <div class="add-report-controls">
                            <div class="period-selector" style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px; flex-wrap: wrap;">
                                <div class="filter-group">
                                    <label for="modal-new-report-month" style="font-weight: 500; margin-bottom: 5px; display: block;">Month:</label>
                                    <select id="modal-new-report-month" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="1">January</option>
                                        <option value="2">February</option>
                                        <option value="3">March</option>
                                        <option value="4">April</option>
                                        <option value="5">May</option>
                                        <option value="6">June</option>
                                        <option value="7">July</option>
                                        <option value="8">August</option>
                                        <option value="9">September</option>
                                        <option value="10">October</option>
                                        <option value="11">November</option>
                                        <option value="12">December</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label for="modal-new-report-year" style="font-weight: 500; margin-bottom: 5px; display: block;">Year:</label>
                                    <select id="modal-new-report-year" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="2024">2024</option>
                                        <option value="2025">2025</option>
                                        <option value="2026">2026</option>
                                    </select>
                                </div>
                                <div class="filter-group" style="margin-top: 20px;">
                                    <button onclick="addNewKpiReportModal()" style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                                        <i class="fas fa-plus"></i> Add Report
                                    </button>
                                </div>
                            </div>
                            <div id="modal-new-report-status" style="font-size: 0.9rem; color: #666; margin-top: 10px;"></div>
                        </div>
                    </div>
                `;
                return;
            }
            
            // Sort by period (newest first)
            filteredResults.sort((a, b) => {
                if (a.period_year !== b.period_year) {
                    return b.period_year - a.period_year;
                }
                return b.period_month - a.period_month;
            });
            
            // Calculate statistics
            const stats = calculateHistoryStats(filteredResults);
            
            // Generate the comprehensive report
            contentElement.innerHTML = `
                <div class="history-report-header">
                    <div class="history-report-title">${currentScorecard.name}</div>
                    <div class="history-report-subtitle">Comprehensive Performance History Report - ${getFilterDisplayName()}</div>
                </div>
                
                <div class="history-stats-grid">
                    <div class="history-stat-card">
                        <div class="history-stat-value">${filteredResults.length}</div>
                        <div class="history-stat-label">Total Periods</div>
                    </div>
                    <div class="history-stat-card">
                        <div class="history-stat-value">${stats.averageScore.toFixed(1)}%</div>
                        <div class="history-stat-label">Average Score</div>
                    </div>
                    <div class="history-stat-card">
                        <div class="history-stat-value">${stats.bestScore.toFixed(1)}%</div>
                        <div class="history-stat-label">Best Performance</div>
                    </div>
                    <div class="history-stat-card">
                        <div class="history-stat-value">${stats.submittedCount}</div>
                        <div class="history-stat-label">Submitted</div>
                    </div>
                    <div class="history-stat-card">
                        <div class="history-stat-value">${stats.approvedCount}</div>
                        <div class="history-stat-label">Approved</div>
                    </div>
                    <div class="history-stat-card">
                        <div class="history-stat-value">${stats.trend}</div>
                        <div class="history-stat-label">Performance Trend</div>
                    </div>
                </div>
                
                <div class="history-timeline">
                    <h4><i class="fas fa-history"></i> Performance Timeline</h4>
                    ${generateTimelineHTML(filteredResults)}
                </div>
                
                <div class="performance-chart">
                    <h4><i class="fas fa-chart-bar"></i> Performance Chart</h4>
                    <div class="chart-container">
                        ${generatePerformanceChartHTML(filteredResults)}
                    </div>
                </div>
                
                <div class="kpi-breakdown">
                    <h4><i class="fas fa-list-ul"></i> KPI Performance Breakdown</h4>
                    ${generateKPIBreakdownHTML(filteredResults)}
                </div>
                
                <div class="export-section">
                    <h4><i class="fas fa-download"></i> Export Report</h4>
                    <p>Download this comprehensive report in your preferred format</p>
                    <div class="export-buttons">
                        <button class="export-btn pdf" onclick="exportHistoryReport('pdf')">
                            <i class="fas fa-file-pdf"></i> Export as PDF
                        </button>
                        <button class="export-btn excel" onclick="exportHistoryReport('excel')">
                            <i class="fas fa-file-excel"></i> Export as Excel
                        </button>
                    </div>
                </div>
            `;
        }
        
        function calculateHistoryStats(results) {
            const scores = results.map(r => r.total_score || 0).filter(s => s > 0);
            const averageScore = scores.length > 0 ? scores.reduce((a, b) => a + b, 0) / scores.length : 0;
            const bestScore = scores.length > 0 ? Math.max(...scores) : 0;
            
            const submittedCount = results.filter(r => r.status === 'submitted' || r.submitted_at).length;
            const approvedCount = results.filter(r => r.status === 'approved').length;
            
            // Calculate trend (comparing last 3 periods if available)
            let trend = 'Stable';
            if (scores.length >= 3) {
                const recent = scores.slice(0, 3);
                const older = scores.slice(3, 6);
                if (recent.length >= 2 && older.length >= 2) {
                    const recentAvg = recent.reduce((a, b) => a + b, 0) / recent.length;
                    const olderAvg = older.reduce((a, b) => a + b, 0) / older.length;
                    if (recentAvg > olderAvg + 5) trend = '↗️ Improving';
                    else if (recentAvg < olderAvg - 5) trend = '↘️ Declining';
                    else trend = '→ Stable';
                }
            }
            
            return {
                averageScore,
                bestScore,
                submittedCount,
                approvedCount,
                trend
            };
        }
        
        function generateTimelineHTML(results) {
            const monthNames = [
                'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'
            ];
            
            return results.map((result, index) => {
                let period, status, score, date, periodData;
                
                if (currentHistoryFilters.periodType === 'month') {
                    // Original monthly data
                    period = `${monthNames[result.period_month - 1]} ${result.period_year}`;
                    // Prioritize explicit status field, fallback to submitted_at logic only if status is not set
                    status = result.status || (result.submitted_at && !result.status ? 'submitted' : 'draft');
                    score = result.total_score ? `${result.total_score.toFixed(1)}%` : 'No data';
                    date = result.submitted_at ? new Date(result.submitted_at).toLocaleDateString() : 'Not submitted';
                    periodData = { month: result.period_month, year: result.period_year, type: 'month' };
                } else {
                    // Grouped data
                    period = result.period_label;
                    status = 'aggregated';
                    score = result.total_score ? `${result.total_score.toFixed(1)}%` : 'No data';
                    date = `${result.count || 0} periods aggregated`;
                    periodData = { 
                        period_label: result.period_label, 
                        results: result.results || [], 
                        type: currentHistoryFilters.periodType 
                    };
                }
                
                let iconClass = 'draft';
                let iconSymbol = '📝';
                if (status === 'submitted') {
                    iconClass = 'submitted';
                    iconSymbol = '📤';
                } else if (status === 'approved') {
                    iconClass = 'approved';
                    iconSymbol = '✅';
                } else if (status === 'aggregated') {
                    iconClass = 'approved';
                    iconSymbol = '📊';
                }
                
                return `
                    <div class="timeline-item" onclick="openScorecardEditor(${JSON.stringify(periodData).replace(/"/g, '&quot;')})" style="cursor: pointer; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#f8f9fa'" onmouseout="this.style.backgroundColor='transparent'">
                        <div class="timeline-icon ${iconClass}">
                            ${iconSymbol}
                        </div>
                        <div class="timeline-content">
                            <div class="timeline-period">${period}</div>
                            <div class="timeline-status">
                                Status: ${status.charAt(0).toUpperCase() + status.slice(1)} | 
                                Score: <span class="timeline-score">${score}</span> | 
                                Date: ${date}
                            </div>
                            <div class="timeline-hint" style="font-size: 0.8rem; color: #666; margin-top: 5px;">
                                <i class="fas fa-edit"></i> Click to edit scorecard
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function applyFiltersToData(data) {
            let filteredData = [...data];
            
            // Apply year filter
            if (currentHistoryFilters.year !== 'all') {
                filteredData = filteredData.filter(r => r.period_year == currentHistoryFilters.year);
            }
            
            // Apply period type filter
            if (currentHistoryFilters.periodType === 'quarter') {
                filteredData = groupDataByQuarter(filteredData);
            } else if (currentHistoryFilters.periodType === 'season') {
                filteredData = groupDataBySeason(filteredData);
            } else if (currentHistoryFilters.periodType === 'year') {
                filteredData = groupDataByYear(filteredData);
            }
            // For 'month', keep as is
            
            return filteredData;
        }
        
        function groupDataByQuarter(data) {
            const quarters = {};
            
            data.forEach(result => {
                const quarter = Math.ceil(result.period_month / 3);
                const key = `Q${quarter} ${result.period_year}`;
                
                if (!quarters[key]) {
                    quarters[key] = {
                        period_label: key,
                        period_year: result.period_year,
                        period_quarter: quarter,
                        results: [],
                        total_score: 0,
                        count: 0
                    };
                }
                
                quarters[key].results.push(result);
                if (result.total_score) {
                    quarters[key].total_score += result.total_score;
                    quarters[key].count++;
                }
            });
            
            // Calculate average scores
            Object.values(quarters).forEach(quarter => {
                quarter.total_score = quarter.count > 0 ? quarter.total_score / quarter.count : 0;
            });
            
            return Object.values(quarters).sort((a, b) => {
                if (a.period_year !== b.period_year) return b.period_year - a.period_year;
                return b.period_quarter - a.period_quarter;
            });
        }
        
        function groupDataBySeason(data) {
            const seasons = {};
            
            data.forEach(result => {
                let season, key;
                if (result.period_month >= 4 && result.period_month <= 9) {
                    season = 'Summer';
                    key = `Summer ${result.period_year}`;
                } else {
                    season = 'Winter';
                    key = `Winter ${result.period_year}`;
                }
                
                if (!seasons[key]) {
                    seasons[key] = {
                        period_label: key,
                        period_year: result.period_year,
                        season: season,
                        results: [],
                        total_score: 0,
                        count: 0
                    };
                }
                
                seasons[key].results.push(result);
                if (result.total_score) {
                    seasons[key].total_score += result.total_score;
                    seasons[key].count++;
                }
            });
            
            // Calculate average scores
            Object.values(seasons).forEach(season => {
                season.total_score = season.count > 0 ? season.total_score / season.count : 0;
            });
            
            return Object.values(seasons).sort((a, b) => {
                if (a.period_year !== b.period_year) return b.period_year - a.period_year;
                return a.season === 'Summer' ? -1 : 1; // Summer first
            });
        }
        
        function groupDataByYear(data) {
            const years = {};
            
            data.forEach(result => {
                const key = result.period_year.toString();
                
                if (!years[key]) {
                    years[key] = {
                        period_label: key,
                        period_year: result.period_year,
                        results: [],
                        total_score: 0,
                        count: 0
                    };
                }
                
                years[key].results.push(result);
                if (result.total_score) {
                    years[key].total_score += result.total_score;
                    years[key].count++;
                }
            });
            
            // Calculate average scores
            Object.values(years).forEach(year => {
                year.total_score = year.count > 0 ? year.total_score / year.count : 0;
            });
            
            return Object.values(years).sort((a, b) => b.period_year - a.period_year);
        }
        
        function getFilterDisplayName() {
            const periodNames = {
                'month': 'Monthly',
                'quarter': 'Quarterly',
                'season': 'Seasonal',
                'year': 'Yearly'
            };
            
            const yearText = currentHistoryFilters.year === 'all' ? 'All Years' : currentHistoryFilters.year;
            return `${periodNames[currentHistoryFilters.periodType]} - ${yearText}`;
        }
        
        function generatePerformanceChartHTML(results) {
            const monthNames = [
                'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'
            ];
            
            // Handle different data structures based on period type
            let chartData = [];
            
            if (currentHistoryFilters.periodType === 'month') {
                // Original monthly data
                chartData = results.map(result => ({
                    label: `${monthNames[result.period_month - 1]} ${result.period_year}`,
                    score: result.total_score || 0
                }));
            } else {
                // Grouped data (quarter, season, year)
                chartData = results.map(result => ({
                    label: result.period_label,
                    score: result.total_score || 0
                }));
            }
            
            // Reverse to show oldest to newest
            chartData.reverse();
            const maxScore = Math.max(...chartData.map(d => d.score), 100);
            
            return chartData.map(data => {
                const height = (data.score / maxScore) * 250; // Max height 250px
                const color = data.score >= 80 ? '#28a745' : data.score >= 60 ? '#ffc107' : '#dc3545';
                
                return `
                    <div class="chart-bar" style="height: ${height}px; background: ${color};">
                        ${data.score.toFixed(0)}
                        <div class="chart-label">${data.label}</div>
                    </div>
                `;
            }).join('');
        }
        
        function generateKPIBreakdownHTML(results) {
            if (!currentScorecard) return '<p>No scorecard selected</p>';
            
            const kpis = DB.getKPIsByScorecard(currentScorecard.id);
            if (!kpis || kpis.length === 0) return '<p>No KPIs found for this scorecard</p>';
            
            return `
                <div class="kpi-breakdown-grid">
                    ${kpis.map(kpi => {
                        let averageValue = 0, averagePerformance = 0, totalValue = 0, dataPoints = 0;
                        
                        if (currentHistoryFilters.periodType === 'month') {
                            // Calculate from individual monthly results
                            const kpiValues = results.map(r => r.kpi_values && r.kpi_values[kpi.id]).filter(v => v !== null && v !== undefined);
                            totalValue = kpiValues.reduce((a, b) => a + b, 0);
                            dataPoints = kpiValues.length;
                            averageValue = dataPoints > 0 ? totalValue / dataPoints : 0;
                        } else {
                            // Calculate from aggregated results
                            results.forEach(result => {
                                if (result.results) {
                                    result.results.forEach(r => {
                                        if (r.kpi_values && r.kpi_values[kpi.id]) {
                                            totalValue += r.kpi_values[kpi.id];
                                            dataPoints++;
                                        }
                                    });
                                }
                            });
                            averageValue = dataPoints > 0 ? totalValue / dataPoints : 0;
                        }
                        
                        averagePerformance = averageValue > 0 ? ((averageValue / kpi.target) * 100).toFixed(1) : 0;
                        
                        return `
                            <div class="kpi-breakdown-item">
                                <div class="kpi-breakdown-name">${kpi.name}</div>
                                <div class="kpi-breakdown-stats">
                                    <span>Target: ${kpi.target} ${kpi.unit}</span>
                                    <span>Total: ${totalValue.toFixed(1)} ${kpi.unit}</span>
                                    <span>Avg: ${averageValue.toFixed(1)} ${kpi.unit}</span>
                                    <span>Performance: ${averagePerformance}%</span>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }
        
        function exportHistoryReport(format) {
            if (!currentScorecard) {
                alert('Please select a scorecard first');
                return;
            }
            
            const results = DB.get('scorecard_results') || [];
            const scorecardResults = results.filter(r => r.scorecard_id === currentScorecard.id);
            
            if (format === 'excel') {
                exportHistoryToExcel(scorecardResults);
            } else if (format === 'pdf') {
                exportHistoryToPDF(scorecardResults);
            }
        }
        
        function exportHistoryToExcel(results) {
            const monthNames = [
                'January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'
            ];
            
            let csvContent = 'data:text/csv;charset=utf-8,';
            csvContent += 'Period,Status,Total Score,Submitted Date,KPIs with Data\n';
            
            results.forEach(result => {
                const period = `${monthNames[result.period_month - 1]} ${result.period_year}`;
                const status = result.status || (result.submitted_at ? 'submitted' : 'draft');
                const score = result.total_score ? result.total_score.toFixed(1) : 'No data';
                const date = result.submitted_at ? new Date(result.submitted_at).toLocaleDateString() : 'Not submitted';
                const kpiCount = result.kpi_values ? Object.keys(result.kpi_values).length : 0;
                
                csvContent += `"${period}","${status}","${score}","${date}","${kpiCount}"\n`;
            });
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement('a');
            link.setAttribute('href', encodedUri);
            link.setAttribute('download', `${currentScorecard.name}_History_Report.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function exportHistoryToPDF(results) {
            // For now, we'll create a simple text-based PDF-like export
            // In a real implementation, you'd use a library like jsPDF
            alert('PDF export functionality would be implemented with a PDF library like jsPDF. For now, please use the Excel export.');
        }
        
        // Scorecard Editor Functions
        let editorScorecard = null;
        let editorPeriod = { month: 6, year: 2025 };
        let editorKpiData = {};
        
        function openScorecardEditor(periodData) {
            console.log('🔧 Opening scorecard editor for period:', periodData);
            
            if (periodData.type === 'month') {
                // Direct month - open editor immediately
                editorPeriod = { month: periodData.month, year: periodData.year };
                openEditorModal();
            } else {
                // Aggregated period - show month selection
                showPeriodSelectionModal(periodData);
            }
        }
        
        function showPeriodSelectionModal(periodData) {
            console.log('📅 Showing period selection for:', periodData);
            
            const modal = document.getElementById('period-selection-modal');
            const content = document.getElementById('period-selection-content');
            
            let monthOptions = '';
            
            if (periodData.type === 'quarter') {
                // Generate quarter months
                const quarter = periodData.period_label.match(/Q(\d)/)[1];
                const year = periodData.period_label.match(/(\d{4})/)[1];
                const startMonth = (quarter - 1) * 3 + 1;
                
                for (let i = 0; i < 3; i++) {
                    const month = startMonth + i;
                    const monthName = new Date(year, month - 1).toLocaleString('default', { month: 'long' });
                    monthOptions += `
                        <div class="period-option" onclick="selectPeriodForEditor(${month}, ${year})" style="padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 10px; cursor: pointer; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#f8f9fa'" onmouseout="this.style.backgroundColor='white'">
                            <strong>${monthName} ${year}</strong>
                        </div>
                    `;
                }
            } else if (periodData.type === 'season') {
                // Generate season months
                const season = periodData.period_label.match(/(Summer|Winter)/)[1];
                const year = periodData.period_label.match(/(\d{4})/)[1];
                
                if (season === 'Summer') {
                    // April to September
                    for (let month = 4; month <= 9; month++) {
                        const monthName = new Date(year, month - 1).toLocaleString('default', { month: 'long' });
                        monthOptions += `
                            <div class="period-option" onclick="selectPeriodForEditor(${month}, ${year})" style="padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 10px; cursor: pointer; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#f8f9fa'" onmouseout="this.style.backgroundColor='white'">
                                <strong>${monthName} ${year}</strong>
                            </div>
                        `;
                    }
                } else {
                    // October to March
                    for (let month = 10; month <= 12; month++) {
                        const monthName = new Date(year, month - 1).toLocaleString('default', { month: 'long' });
                        monthOptions += `
                            <div class="period-option" onclick="selectPeriodForEditor(${month}, ${year})" style="padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 10px; cursor: pointer; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#f8f9fa'" onmouseout="this.style.backgroundColor='white'">
                                <strong>${monthName} ${year}</strong>
                            </div>
                        `;
                    }
                    for (let month = 1; month <= 3; month++) {
                        const monthName = new Date(year, month - 1).toLocaleString('default', { month: 'long' });
                        monthOptions += `
                            <div class="period-option" onclick="selectPeriodForEditor(${month}, ${year})" style="padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 10px; cursor: pointer; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#f8f9fa'" onmouseout="this.style.backgroundColor='white'">
                                <strong>${monthName} ${year}</strong>
                            </div>
                        `;
                    }
                }
            } else if (periodData.type === 'year') {
                // Generate all months for the year
                const year = periodData.period_label;
                for (let month = 1; month <= 12; month++) {
                    const monthName = new Date(year, month - 1).toLocaleString('default', { month: 'long' });
                    monthOptions += `
                        <div class="period-option" onclick="selectPeriodForEditor(${month}, ${year})" style="padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 10px; cursor: pointer; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#f8f9fa'" onmouseout="this.style.backgroundColor='white'">
                            <strong>${monthName} ${year}</strong>
                        </div>
                    `;
                }
            }
            
            content.innerHTML = monthOptions;
            modal.style.display = 'block';
        }
        
        function selectPeriodForEditor(month, year) {
            console.log(`📅 Selected period for editor: ${month}/${year}`);
            editorPeriod = { month: month, year: year };
            
            // Close period selection modal
            document.getElementById('period-selection-modal').style.display = 'none';
            
            // Open editor modal
            openEditorModal();
        }
        
        function openEditorModal() {
            console.log('🔧 Opening editor modal for period:', editorPeriod);
            
            // Set the current scorecard for the editor
            editorScorecard = currentScorecard;
            
            if (!editorScorecard) {
                alert('No scorecard selected');
                return;
            }
            
            // Update modal title and period badge
            const modalTitle = document.getElementById('editor-modal-title');
            const scorecardTitle = document.getElementById('editor-scorecard-title');
            const periodBadge = document.getElementById('editor-period-badge');
            
            if (modalTitle) modalTitle.textContent = `Scorecard Editor - ${editorScorecard.name}`;
            if (scorecardTitle) scorecardTitle.textContent = `KPI Entry & Performance - ${editorScorecard.name}`;
            
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            if (periodBadge) periodBadge.textContent = `${monthNames[editorPeriod.month - 1]} ${editorPeriod.year}`;
            
            // Load KPI entries for the editor
            loadEditorKpiEntries();
            
            // Load period data for the editor
            loadEditorPeriodData();
            

            
            // Show the modal
            document.getElementById('scorecard-editor-modal').style.display = 'block';
        }
        
        function loadEditorKpiEntries() {
            if (!editorScorecard) return;
            
            const kpis = DB.getKPIsByScorecard(editorScorecard.id);
            const kpiEntriesContainer = document.getElementById('editor-kpi-entries');
            
            if (!kpiEntriesContainer) return;
            
            // Check access permissions
            const canEnter = canEnterKpiValues(editorScorecard);
            const canSubmit = canSubmitScorecard(editorScorecard);
            const canApprove = canApproveScorecard(editorScorecard);
            
            console.log('🔐 Editor access permissions:', { canEnter, canSubmit, canApprove });
            
            // Check if scorecard is locked
            const existingResults = DB.get('scorecard_results') || [];
            const existingResult = existingResults.find(r => 
                r.scorecard_id === editorScorecard.id && 
                r.period_month === editorPeriod.month && 
                r.period_year === editorPeriod.year
            );
            const isLocked = isScorecardLocked(existingResult);
            
            console.log('🔒 Editor scorecard locked:', isLocked);
            
            // Show/hide form based on permissions
            const kpiForm = document.getElementById('editor-kpi-form');
            const noScorecard = document.getElementById('editor-no-scorecard');
            
            if (!canEnter && !canSubmit && !canApprove) {
                if (kpiForm) kpiForm.style.display = 'none';
                if (noScorecard) {
                    noScorecard.style.display = 'block';
                    noScorecard.innerHTML = `
                        <div class="access-denied-message" style="text-align: center; padding: 2rem; color: #666;">
                            <i class="fas fa-lock" style="font-size: 3rem; margin-bottom: 1rem; color: #999;"></i>
                            <h3>Access Denied</h3>
                            <p>You do not have permission to view or edit this scorecard.</p>
                        </div>
                    `;
                }
                return;
            }
            
            if (kpiForm) kpiForm.style.display = 'block';
            if (noScorecard) noScorecard.style.display = 'none';
            
            if (isLocked) {
                // Scorecard is locked - show read-only view
                kpiEntriesContainer.innerHTML = `
                    <div class="locked-message" style="text-align: center; padding: 1rem; background: #f8f9fa; border-radius: 8px; margin-bottom: 1rem;">
                        <i class="fas fa-check-circle" style="color: #28a745; margin-right: 0.5rem;"></i>
                        <strong>Scorecard Approved</strong> - This scorecard has been approved and is locked for editing.
                    </div>
                `;
            } else {
                // Generate KPI entries
                kpiEntriesContainer.innerHTML = '';
                kpis.forEach(kpi => {
                    const kpiEntry = document.createElement('div');
                    kpiEntry.className = 'kpi-entry-item';
                    
                    const inputDisabled = !canEnter || isLocked;
                    
                    kpiEntry.innerHTML = `
                        <div class="kpi-info">
                            <div class="kpi-name">${kpi.name}</div>
                            <div class="kpi-details">Weight: ${kpi.weight}% | Unit: ${kpi.unit}</div>
                        </div>
                        <div class="kpi-target">${kpi.target} ${kpi.unit}</div>
                        <input type="number" 
                               id="editor-kpi-input-${kpi.id}" 
                               class="kpi-input" 
                               placeholder="Enter value"
                               onchange="updateEditorKpiValue(${kpi.id}, this.value)"
                               ${inputDisabled ? 'disabled' : ''}>
                        <div class="kpi-performance" id="editor-kpi-performance-${kpi.id}">
                            <span>--</span>
                        </div>
                    `;
                    kpiEntriesContainer.appendChild(kpiEntry);
                });
            }
            
            // Update button visibility
            updateEditorButtonVisibility(canEnter, canSubmit, canApprove, isLocked);
            
            console.log(`✅ Loaded ${kpis.length} KPI entries for editor`);
        }
        
        function updateEditorButtonVisibility(canEnter, canSubmit, canApprove, isLocked) {
            console.log('🔧 Updating editor button visibility:', { canEnter, canSubmit, canApprove, isLocked });
            
            const saveBtn = document.querySelector('#scorecard-editor-modal .btn-save');
            const resetBtn = document.querySelector('#scorecard-editor-modal .btn-reset');
            const submitBtn = document.querySelector('#scorecard-editor-modal .btn-submit');
            const approveBtn = document.querySelector('#scorecard-editor-modal .btn-approve');
            
            // Save and Reset buttons
            if (saveBtn) saveBtn.style.display = (canEnter && !isLocked) ? 'inline-flex' : 'none';
            if (resetBtn) resetBtn.style.display = (canEnter && !isLocked) ? 'inline-flex' : 'none';
            
            // Submit button
            if (submitBtn) {
                const shouldShowSubmit = canSubmit && !isLocked;
                submitBtn.style.display = shouldShowSubmit ? 'inline-flex' : 'none';
            }
            
            // Approve button
            if (approveBtn) approveBtn.style.display = (canApprove && !isLocked) ? 'inline-flex' : 'none';
            
            console.log('✅ Editor button visibility updated');
        }
        
        function updateEditorKpiValue(kpiId, value) {
            // Check if scorecard is locked
            if (editorScorecard) {
                const existingResults = DB.get('scorecard_results') || [];
                const existingResult = existingResults.find(r => 
                    r.scorecard_id === editorScorecard.id && 
                    r.period_month === editorPeriod.month && 
                    r.period_year === editorPeriod.year
                );
                
                if (isScorecardLocked(existingResult)) {
                    console.log('🔒 Editor scorecard is locked, cannot update KPI values');
                    return;
                }
            }
            
            const numValue = parseFloat(value);
            editorKpiData[kpiId] = isNaN(numValue) ? null : numValue;
            
            const kpi = DB.getById('kpis', kpiId);
            if (kpi) {
                updateEditorKpiPerformance(kpiId, numValue, kpi);
            }
            
            updateEditorPerformanceResults();
        }
        
        function updateEditorKpiPerformance(kpiId, value, kpi) {
            const performanceElement = document.getElementById(`editor-kpi-performance-${kpiId}`);
            if (!performanceElement) return;
            
            if (value === null || isNaN(value)) {
                performanceElement.innerHTML = '<span>--</span>';
                performanceElement.className = 'kpi-performance performance-unknown';
                return;
            }
            
            const percentage = (value / kpi.target) * 100;
            let performanceClass = 'performance-below';
            let performanceText = `${percentage.toFixed(1)}%`;
            
            if (percentage >= 100) {
                performanceClass = 'performance-above';
                performanceText = `${percentage.toFixed(1)}% ✓`;
            } else if (percentage >= 90) {
                performanceClass = 'performance-on-target';
                performanceText = `${percentage.toFixed(1)}% ~`;
            }
            
            performanceElement.innerHTML = `<span>${performanceText}</span>`;
            performanceElement.className = `kpi-performance ${performanceClass}`;
        }
        
        function loadEditorPeriodData() {
            console.log('🔄 loadEditorPeriodData() called');
            console.log(`📊 Editor scorecard:`, editorScorecard);
            console.log(`📅 Editor period:`, editorPeriod);
            
            if (!editorScorecard) {
                console.warn('⚠️ No editor scorecard selected');
                clearEditorKpiForm();
                return;
            }
            
            // Load existing data for editor period
            const existingResults = DB.get('scorecard_results') || [];
            const existingResult = existingResults.find(r => 
                r.scorecard_id === editorScorecard.id && 
                r.period_month === editorPeriod.month && 
                r.period_year === editorPeriod.year
            );
            
            if (existingResult) {
                console.log(`✅ Found existing data for editor period ${editorPeriod.month}/${editorPeriod.year}:`, existingResult);
                editorKpiData = { ...existingResult.kpi_values };
                
                // Populate form fields
                Object.keys(editorKpiData).forEach(kpiId => {
                    const input = document.getElementById(`editor-kpi-input-${kpiId}`);
                    if (input) {
                        input.value = editorKpiData[kpiId];
                        console.log(`📝 Populated editor KPI ${kpiId} with value:`, editorKpiData[kpiId]);
                        
                        const kpi = DB.getById('kpis', parseInt(kpiId));
                        if (kpi) {
                            updateEditorKpiPerformance(parseInt(kpiId), editorKpiData[kpiId], kpi);
                        }
                    }
                });
                
                updateEditorPerformanceResults();
                updateEditorStatusDisplay(existingResult);
                console.log('✅ Editor KPI form populated with existing data');
            } else {
                console.log(`📝 No existing data found for editor period ${editorPeriod.month}/${editorPeriod.year}, clearing form`);
                clearEditorKpiForm();
                updateEditorStatusDisplay(null);
            }
        }
        
        function clearEditorKpiForm() {
            console.log('🧹 Clearing editor KPI form...');
            
            editorKpiData = {};
            const inputs = document.querySelectorAll('#scorecard-editor-modal .kpi-input');
            console.log(`📝 Clearing ${inputs.length} editor KPI input fields`);
            
            inputs.forEach(input => {
                input.value = '';
            });
            
            const performances = document.querySelectorAll('#scorecard-editor-modal .kpi-performance');
            console.log(`📊 Resetting ${performances.length} editor performance indicators`);
            
            performances.forEach(perf => {
                perf.innerHTML = '<span>--</span>';
                perf.className = 'kpi-performance performance-unknown';
            });
            
            // Hide performance summary
            const performanceSummary = document.getElementById('editor-performance-summary');
            if (performanceSummary) {
                performanceSummary.style.display = 'none';
            }
            
            console.log('✅ Editor KPI form cleared successfully');
        }
        
        function updateEditorPerformanceResults() {
            console.log('🔄 updateEditorPerformanceResults() called');
            
            if (!editorScorecard) {
                console.warn('⚠️ No editor scorecard selected, cannot update performance results');
                return;
            }
            
            const kpis = DB.getKPIsByScorecard(editorScorecard.id);
            console.log(`📊 Processing ${kpis.length} KPIs for editor performance calculation`);
            
            let totalScore = 0;
            let totalWeight = 0;
            let kpisWithData = 0;
            let onTarget = 0;
            let belowTarget = 0;
            let aboveTarget = 0;
            
            kpis.forEach(kpi => {
                const value = editorKpiData[kpi.id];
                if (value !== null && !isNaN(value)) {
                    kpisWithData++;
                    const percentage = (value / kpi.target) * 100;
                    const weightedScore = (percentage * kpi.weight) / 100;
                    totalScore += weightedScore;
                    totalWeight += kpi.weight;
                    
                    if (percentage >= 100) {
                        aboveTarget++;
                    } else if (percentage >= 90) {
                        onTarget++;
                    } else {
                        belowTarget++;
                    }
                }
            });
            
            const overallScore = totalWeight > 0 ? (totalScore / totalWeight) * 100 : 0;
            console.log(`🎯 Editor Overall Score: ${overallScore.toFixed(1)}% (${kpisWithData}/${kpis.length} KPIs with data)`);
            
            // Update display in the editor performance summary
            const overallScoreElement = document.getElementById('editor-overall-score');
            const kpisWithDataElement = document.getElementById('editor-kpis-with-data');
            const onTargetElement = document.getElementById('editor-on-target-count');
            const belowTargetElement = document.getElementById('editor-below-target-count');
            const aboveTargetElement = document.getElementById('editor-above-target-count');
            
            if (overallScoreElement) overallScoreElement.textContent = overallScore.toFixed(1);
            if (kpisWithDataElement) kpisWithDataElement.textContent = `${kpisWithData}/${kpis.length}`;
            if (onTargetElement) onTargetElement.textContent = onTarget;
            if (belowTargetElement) belowTargetElement.textContent = belowTarget;
            if (aboveTargetElement) aboveTargetElement.textContent = aboveTarget;
            
            // Show the performance summary
            const performanceSummary = document.getElementById('editor-performance-summary');
            if (performanceSummary) {
                performanceSummary.style.display = 'block';
            }
            
            console.log('✅ Editor performance results updated successfully');
        }
        
        function updateEditorStatusDisplay(scorecardResult) {
            const statusDisplay = document.getElementById('editor-status-display');
            const currentStatus = document.getElementById('editor-current-status');
            const approvalInfo = document.getElementById('editor-approval-info');
            const approveBtn = document.querySelector('#scorecard-editor-modal .btn-approve');
            
            if (!statusDisplay || !currentStatus || !approvalInfo) return;
            
            if (!scorecardResult) {
                statusDisplay.style.display = 'none';
                if (approveBtn) approveBtn.style.display = 'none';
                return;
            }
            
            statusDisplay.style.display = 'block';
            
            // Use the status field from the database
            const status = scorecardResult.status || 'draft';
            
            currentStatus.textContent = status.charAt(0).toUpperCase() + status.slice(1);
            
            // Set status color
            let statusColor = '#6c757d'; // Default gray
            if (status === 'approved') statusColor = '#28a745'; // Green
            else if (status === 'submitted') statusColor = '#ffc107'; // Yellow
            else if (status === 'draft') statusColor = '#6c757d'; // Gray
            
            currentStatus.style.color = statusColor;
            currentStatus.style.fontWeight = 'bold';
            
            // Show approval information
            let approvalText = '';
            if (status === 'approved') {
                approvalText = 'Scorecard has been approved and is locked for editing';
            } else if (status === 'submitted') {
                approvalText = 'Scorecard has been submitted and is awaiting approval';
            } else if (status === 'draft') {
                approvalText = 'Ready for submission';
            }
            
            approvalInfo.textContent = approvalText;
            
            // Show/hide approve button based on permissions
            if (approveBtn) {
                const canApprove = canApproveScorecard(editorScorecard);
                approveBtn.style.display = canApprove ? 'inline-block' : 'none';
                
                // Update button text based on user role
                const currentUser = DB.getCurrentUser();
                if (currentUser && currentUser.role === 'HR Manager') {
                    approveBtn.innerHTML = '<i class="fas fa-check"></i> Final Approve';
                } else {
                    approveBtn.innerHTML = '<i class="fas fa-check"></i> Approve';
                }
            }
        }
        

        
        function saveEditorKpiData() {
            if (!editorScorecard) {
                alert('Please select a scorecard first');
                return;
            }
            
            console.log('💾 Saving editor KPI data...');
            console.log('📊 Editor KPI data:', editorKpiData);
            console.log('📅 Editor period:', editorPeriod);
            
            // Check if we have any data to save
            const kpis = DB.getKPIsByScorecard(editorScorecard.id);
            const kpiValues = {};
            let hasData = false;
            
            kpis.forEach(kpi => {
                const value = editorKpiData[kpi.id];
                if (value !== null && !isNaN(value)) {
                    kpiValues[kpi.id] = value;
                    hasData = true;
                }
            });
            
            if (!hasData) {
                alert('Please enter at least one KPI value');
                return;
            }
            
            try {
                // Calculate overall score
                let totalScore = 0;
                let totalWeight = 0;
                
                kpis.forEach(kpi => {
                    const value = kpiValues[kpi.id];
                    if (value !== null && !isNaN(value)) {
                        const percentage = (value / kpi.target) * 100;
                        const weightedScore = (percentage * kpi.weight) / 100;
                        totalScore += weightedScore;
                        totalWeight += kpi.weight;
                    }
                });
                
                const overallScore = totalWeight > 0 ? (totalScore / totalWeight) * 100 : 0;
                
                // Save to database
                const resultData = {
                    scorecard_id: editorScorecard.id,
                    user_id: DB.getCurrentUser()?.id || 1,
                    period_month: editorPeriod.month,
                    period_year: editorPeriod.year,
                    kpi_values: kpiValues,
                    total_score: overallScore,
                    status: 'draft',
                    is_auto_save: false
                };
                
                // Check if result already exists
                const existingResults = DB.get('scorecard_results') || [];
                const existingResult = existingResults.find(r => 
                    r.scorecard_id === editorScorecard.id && 
                    r.period_month === editorPeriod.month && 
                    r.period_year === editorPeriod.year
                );
                
                if (existingResult) {
                    // Update existing result
                    console.log('📝 Updating existing editor result:', existingResult.id);
                    // Preserve existing status unless we're explicitly setting it to draft
                    const currentStatus = existingResult.status;
                    Object.assign(existingResult, resultData);
                    // Only update status to draft if it was previously draft or if no status exists
                    if (currentStatus && currentStatus !== 'draft') {
                        existingResult.status = currentStatus;
                    }
                    DB.update('scorecard_results', existingResult.id, existingResult);
                    console.log('✅ Updated existing editor scorecard result');
                } else {
                    // Create new result
                    console.log('🆕 Creating new editor result');
                    const addedResult = DB.add('scorecard_results', resultData);
                    console.log('✅ Created new editor scorecard result:', addedResult);
                }
                
                // Sync to Supabase if available
                if (typeof supabaseIntegrationManager !== 'undefined') {
                    console.log('🔄 Syncing editor data to Supabase...');
                    supabaseIntegrationManager.syncToSupabase()
                        .then(() => {
                            console.log('✅ Editor KPI data synced to Supabase');
                            alert('KPI data saved and synced successfully!');
                            
                            // Refresh inline history report to show correct status
                            if (currentScorecard) {
                                generateInlineHistoryReport();
                            }
                        })
                        .catch((error) => {
                            console.warn('⚠️ Editor Supabase sync failed:', error);
                            alert('Saved locally but sync failed');
                        });
                } else {
                    console.log('⚠️ Supabase integration not available, saved locally only');
                    alert('KPI data saved locally!');
                    
                    // Refresh inline history report to show correct status
                    if (currentScorecard) {
                        generateInlineHistoryReport();
                    }
                }
                
                // Refresh the editor display
                loadEditorPeriodData();
                
            } catch (error) {
                console.error('❌ Error saving editor KPI data:', error);
                alert('Error saving KPI data. Please try again.');
            }
        }
        
        function resetEditorKpiData() {
            if (confirm('Are you sure you want to reset all KPI values?')) {
                clearEditorKpiForm();
                alert('KPI data reset successfully!');
            }
        }
        
        function submitEditorScorecard() {
            if (!editorScorecard) {
                alert('Please select a scorecard first');
                return;
            }
            
            const currentUser = DB.getCurrentUser();
            if (!currentUser) {
                alert('Please log in to submit scorecard');
                return;
            }
            
            // Check if user can submit this scorecard
            if (!canSubmitScorecard(editorScorecard)) {
                alert('You do not have permission to submit this scorecard. Only the department manager can submit scorecards.');
                return;
            }
            
            try {
                // Find existing result or create new one
                const results = DB.get('scorecard_results') || [];
                let existingResult = results.find(r => 
                    r.scorecard_id === editorScorecard.id && 
                    r.period_month === editorPeriod.month && 
                    r.period_year === editorPeriod.year
                );
                
                if (existingResult) {
                    // Update existing result
                    const updates = {
                        kpi_values: { ...editorKpiData },
                        total_score: calculateEditorTotalScore(),
                        status: 'submitted',
                        submitted_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    };
                    
                    // Use integration manager to update record
                    if (typeof supabaseIntegrationManager !== 'undefined' && supabaseIntegrationManager.isInitialized) {
                        supabaseIntegrationManager.updateRecord('scorecard_results', existingResult.id, updates)
                            .then(() => {
                                console.log('✅ Editor scorecard result updated via integration manager');
                                alert('Scorecard submitted for approval successfully!');
                                loadEditorPeriodData(); // Refresh the display
                            })
                            .catch((error) => {
                                console.error('❌ Error submitting editor scorecard:', error);
                                alert('Error submitting scorecard. Please try again.');
                            });
                    } else {
                        // Fallback to local storage only
                        const updatedResult = DB.update('scorecard_results', existingResult.id, updates);
                        console.log('✅ Editor scorecard result updated locally only:', updatedResult);
                        alert('Scorecard submitted for approval successfully!');
                        loadEditorPeriodData(); // Refresh the display
                    }
                } else {
                    // Create new result
                    const newResult = {
                        scorecard_id: editorScorecard.id,
                        user_id: currentUser.id,
                        period_month: editorPeriod.month,
                        period_year: editorPeriod.year,
                        kpi_values: { ...editorKpiData },
                        total_score: calculateEditorTotalScore(),
                        status: 'submitted',
                        submitted_at: new Date().toISOString(),
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    };
                    
                    // Use integration manager to create record
                    if (typeof supabaseIntegrationManager !== 'undefined' && supabaseIntegrationManager.isInitialized) {
                        supabaseIntegrationManager.createRecord('scorecard_results', newResult)
                            .then(() => {
                                console.log('✅ Editor scorecard result created via integration manager');
                                alert('Scorecard submitted for approval successfully!');
                                loadEditorPeriodData(); // Refresh the display
                            })
                            .catch((error) => {
                                console.error('❌ Error submitting editor scorecard:', error);
                                alert('Error submitting scorecard. Please try again.');
                            });
                    } else {
                        // Fallback to local storage only
                        const addedResult = DB.add('scorecard_results', newResult);
                        console.log('✅ Editor scorecard result created locally only:', addedResult);
                        alert('Scorecard submitted for approval successfully!');
                        loadEditorPeriodData(); // Refresh the display
                    }
                }
                
            } catch (error) {
                console.error('❌ Error submitting editor scorecard:', error);
                alert('Error submitting scorecard. Please try again.');
            }
        }
        
        function approveEditorScorecard() {
            if (!editorScorecard) {
                alert('Please select a scorecard first');
                return;
            }
            
            const currentUser = DB.getCurrentUser();
            if (!currentUser) {
                alert('Please log in to approve scorecard');
                return;
            }
            
            // Check if user can approve this scorecard
            if (!canApproveScorecard(editorScorecard)) {
                alert('You do not have permission to approve this scorecard. Only the HR manager can approve scorecards.');
                return;
            }
            
            // Find the current scorecard result
            const results = DB.get('scorecard_results') || [];
            const currentResult = results.find(r => 
                r.scorecard_id === editorScorecard.id && 
                r.period_month === editorPeriod.month && 
                r.period_year === editorPeriod.year
            );
            
            if (!currentResult) {
                alert('No scorecard result found for the current period');
                return;
            }
            
            try {
                // Only HR Manager can approve (final approval)
                const updates = {
                    status: 'approved',
                    updated_at: new Date().toISOString()
                };
                
                // Use integration manager to update record
                if (typeof supabaseIntegrationManager !== 'undefined' && supabaseIntegrationManager.isInitialized) {
                    supabaseIntegrationManager.updateRecord('scorecard_results', currentResult.id, updates)
                        .then(() => {
                            console.log('✅ Editor scorecard result approved via integration manager');
                            alert('Scorecard approved successfully! The scorecard is now locked for editing.');
                            loadEditorPeriodData(); // Refresh the display
                        })
                        .catch((error) => {
                            console.error('❌ Error approving editor scorecard:', error);
                            alert('Error approving scorecard. Please try again.');
                        });
                } else {
                    // Fallback to local storage only
                    const updatedResult = DB.update('scorecard_results', currentResult.id, updates);
                    console.log('✅ Editor scorecard result approved locally only:', updatedResult);
                    alert('Scorecard approved successfully! The scorecard is now locked for editing.');
                    loadEditorPeriodData(); // Refresh the display
                }
                
            } catch (error) {
                console.error('❌ Error approving editor scorecard:', error);
                alert('Error approving scorecard. Please try again.');
            }
        }
        
        function calculateEditorTotalScore() {
            if (!editorScorecard) return 0;
            
            const kpis = DB.getKPIsByScorecard(editorScorecard.id);
            let totalScore = 0;
            let totalWeight = 0;
            
            kpis.forEach(kpi => {
                const value = editorKpiData[kpi.id];
                if (value !== null && !isNaN(value)) {
                    const percentage = (value / kpi.target) * 100;
                    const weightedScore = (percentage * kpi.weight) / 100;
                    totalScore += weightedScore;
                    totalWeight += kpi.weight;
                }
            });
            
            return totalWeight > 0 ? (totalScore / totalWeight) * 100 : 0;
        }
        
        // Debug function to reset scorecard status for testing
        function resetScorecardStatus() {
            if (!currentScorecard) {
                alert('Please select a scorecard first');
                return;
            }
            
            const existingResults = DB.get('scorecard_results') || [];
            const existingResult = existingResults.find(r => 
                r.scorecard_id === currentScorecard.id && 
                r.period_month === currentPeriod.month && 
                r.period_year === currentPeriod.year
            );
            
            if (existingResult) {
                // Reset to draft status
                existingResult.status = 'draft';
                existingResult.submitted_at = null;
                DB.update('scorecard_results', existingResult.id, existingResult);
                console.log('🔧 Reset scorecard status to draft for testing');
                alert('Scorecard status reset to draft for testing');
                loadPeriodData(); // Refresh the display
            } else {
                alert('No existing result found for current period');
            }
        }
        
        function addNewKpiReportInline() {
            if (!currentScorecard) {
                document.getElementById('inline-new-report-status').textContent = 'Please select a scorecard first.';
                return;
            }
            const month = parseInt(document.getElementById('inline-new-report-month').value);
            const year = parseInt(document.getElementById('inline-new-report-year').value);
            const statusDiv = document.getElementById('inline-new-report-status');
            
            // Check if a report already exists for this period
            const results = DB.get('scorecard_results') || [];
            const exists = results.some(r => r.scorecard_id === currentScorecard.id && r.period_month === month && r.period_year === year);
            if (exists) {
                statusDiv.textContent = 'A KPI report already exists for this month and year.';
                statusDiv.style.color = '#dc3545';
                return;
            }
            statusDiv.textContent = '';
            statusDiv.style.color = '#666';
            // Open the KPI editor modal for this period
            editorPeriod = { month, year };
            editorScorecard = currentScorecard;
            openEditorModal();
        }
        
        function addNewKpiReportModal() {
            if (!currentScorecard) {
                document.getElementById('modal-new-report-status').textContent = 'Please select a scorecard first.';
                return;
            }
            const month = parseInt(document.getElementById('modal-new-report-month').value);
            const year = parseInt(document.getElementById('modal-new-report-year').value);
            const statusDiv = document.getElementById('modal-new-report-status');
            
            // Check if a report already exists for this period
            const results = DB.get('scorecard_results') || [];
            const exists = results.some(r => r.scorecard_id === currentScorecard.id && r.period_month === month && r.period_year === year);
            if (exists) {
                statusDiv.textContent = 'A KPI report already exists for this month and year.';
                statusDiv.style.color = '#dc3545';
                return;
            }
            statusDiv.textContent = '';
            statusDiv.style.color = '#666';
            // Open the KPI editor modal for this period
            editorPeriod = { month, year };
            editorScorecard = currentScorecard;
            openEditorModal();
        }
        
        // Monthly List Modal Functions
        function openMonthlyListModal() {
            if (!currentScorecard) {
                alert('Please select a scorecard first');
                return;
            }
            
            console.log('📊 Opening Monthly List Modal for scorecard:', currentScorecard.name);
            
            // Initialize filters
            initializeMonthlyListFilters();
            
            // Load initial data
            loadMonthlyListData();
            
            // Show modal
            const modal = document.getElementById('monthly-list-modal');
            modal.style.display = 'block';
        }
        
        function initializeMonthlyListFilters() {
            console.log('🔧 Initializing Monthly List filters...');
            
            // Initialize year filter
            const yearFilter = document.getElementById('monthly-year-filter');
            yearFilter.innerHTML = '<option value="">All Years</option>';
            
            // Get all unique years from scorecard results
            const results = DB.get('scorecard_results') || [];
            const years = [...new Set(results.map(r => r.period_year))].sort((a, b) => b - a);
            
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearFilter.appendChild(option);
            });
            
            // Initialize department filter
            const departmentFilter = document.getElementById('monthly-department-filter');
            departmentFilter.innerHTML = '<option value="">All Departments</option>';
            
            const departments = DB.get('departments') || [];
            departments.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept.name;
                option.textContent = dept.name;
                departmentFilter.appendChild(option);
            });
            
            console.log(`✅ Initialized filters with ${years.length} years and ${departments.length} departments`);
        }
        
        function loadMonthlyListData() {
            console.log('📊 Loading Monthly List data...');
            
            const monthFilter = document.getElementById('monthly-month-filter').value;
            const yearFilter = document.getElementById('monthly-year-filter').value;
            const departmentFilter = document.getElementById('monthly-department-filter').value;
            
            // Get all scorecard results
            const results = DB.get('scorecard_results') || [];
            const scorecards = DB.get('scorecards') || [];
            
            // Filter results based on selected scorecard and filters
            let filteredResults = results.filter(result => {
                const scorecard = scorecards.find(sc => sc.id === result.scorecard_id);
                if (!scorecard) return false;
                
                // Filter by selected scorecard
                if (scorecard.id !== currentScorecard.id) return false;
                
                // Filter by month
                if (monthFilter && result.period_month !== parseInt(monthFilter)) return false;
                
                // Filter by year
                if (yearFilter && result.period_year !== parseInt(yearFilter)) return false;
                
                // Filter by department (scorecard department)
                if (departmentFilter && scorecard.department !== departmentFilter) return false;
                
                return true;
            });
            
            // Sort by date (newest first)
            filteredResults.sort((a, b) => {
                const dateA = new Date(a.created_at || a.submitted_at || 0);
                const dateB = new Date(b.created_at || b.submitted_at || 0);
                return dateB - dateA;
            });
            
            // Store filtered results for pagination
            monthlyListFilteredResults = filteredResults;
            monthlyListTotalResults = filteredResults.length;
            
            // Reset to first page when filtering
            monthlyListCurrentPage = 1;
            
            console.log(`📊 Found ${filteredResults.length} filtered results`);
            
            // Populate table with pagination
            populateMonthlyListTableWithPagination();
        }
        
        function populateMonthlyListTableWithPagination() {
            const tbody = document.getElementById('monthly-list-tbody');
            const emptyState = document.getElementById('monthly-list-empty');
            
            if (monthlyListFilteredResults.length === 0) {
                tbody.innerHTML = '';
                emptyState.style.display = 'block';
                updatePaginationControls();
                return;
            }
            
            emptyState.style.display = 'none';
            
            // Calculate pagination
            const totalPages = Math.ceil(monthlyListTotalResults / monthlyListPageSize);
            const startIndex = (monthlyListCurrentPage - 1) * monthlyListPageSize;
            const endIndex = Math.min(startIndex + monthlyListPageSize, monthlyListTotalResults);
            const currentPageResults = monthlyListFilteredResults.slice(startIndex, endIndex);
            
            const scorecards = DB.get('scorecards') || [];
            const months = [
                'January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'
            ];
            
            tbody.innerHTML = currentPageResults.map(result => {
                const scorecard = scorecards.find(sc => sc.id === result.scorecard_id);
                if (!scorecard) return '';
                
                const monthName = months[result.period_month - 1] || 'Unknown';
                const date = new Date(result.created_at || result.submitted_at || 0);
                const formattedDate = date.toLocaleDateString();
                
                const statusClass = getStatusClass(result.status);
                const statusText = result.status ? result.status.charAt(0).toUpperCase() + result.status.slice(1) : 'Unknown';
                
                return `
                    <tr>
                        <td>${scorecard.name}</td>
                        <td>${scorecard.department}</td>
                        <td>${result.total_score ? result.total_score.toFixed(1) + '%' : 'N/A'}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>${monthName} ${result.period_year}</td>
                        <td>
                            <button class="action-button small" onclick="viewMonthlyListScorecard(${result.id})">
                                <i class="fas fa-eye"></i> View
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            // Update pagination controls
            updatePaginationControls();
        }
        
        function populateMonthlyListTable(results) {
            // Legacy function for backward compatibility
            populateMonthlyListTableWithPagination();
        }
        
        function getStatusClass(status) {
            if (!status) return 'status-draft';
            switch (status) {
                case 'draft': return 'status-draft';
                case 'submitted': return 'status-submitted';
                case 'approved': return 'status-approved';
                default: return 'status-draft';
            }
        }
        
        function updatePaginationControls() {
            const totalPages = Math.ceil(monthlyListTotalResults / monthlyListPageSize);
            const startIndex = (monthlyListCurrentPage - 1) * monthlyListPageSize + 1;
            const endIndex = Math.min(startIndex + monthlyListPageSize - 1, monthlyListTotalResults);
            
            // Update pagination info
            const paginationInfo = document.getElementById('monthly-list-pagination-info');
            if (paginationInfo) {
                paginationInfo.textContent = `Showing ${startIndex} to ${endIndex} of ${monthlyListTotalResults} results`;
            }
            
            // Update previous/next buttons
            const prevButton = document.getElementById('monthly-list-prev-page');
            const nextButton = document.getElementById('monthly-list-next-page');
            
            if (prevButton) {
                prevButton.disabled = monthlyListCurrentPage <= 1;
            }
            if (nextButton) {
                nextButton.disabled = monthlyListCurrentPage >= totalPages;
            }
            
            // Update page numbers
            updatePageNumbers(totalPages);
        }
        
        function updatePageNumbers(totalPages) {
            const pageNumbersContainer = document.getElementById('monthly-list-page-numbers');
            if (!pageNumbersContainer) return;
            
            pageNumbersContainer.innerHTML = '';
            
            if (totalPages <= 1) return;
            
            const maxVisiblePages = 5;
            let startPage = Math.max(1, monthlyListCurrentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            // Adjust start page if we're near the end
            if (endPage - startPage < maxVisiblePages - 1) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            // Add first page and ellipsis if needed
            if (startPage > 1) {
                addPageNumber(1);
                if (startPage > 2) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    ellipsis.style.padding = '0 8px';
                    ellipsis.style.color = '#666';
                    pageNumbersContainer.appendChild(ellipsis);
                }
            }
            
            // Add visible page numbers
            for (let i = startPage; i <= endPage; i++) {
                addPageNumber(i);
            }
            
            // Add last page and ellipsis if needed
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    ellipsis.style.padding = '0 8px';
                    ellipsis.style.color = '#666';
                    pageNumbersContainer.appendChild(ellipsis);
                }
                addPageNumber(totalPages);
            }
        }
        
        function addPageNumber(pageNum) {
            const pageNumbersContainer = document.getElementById('monthly-list-page-numbers');
            const button = document.createElement('button');
            button.textContent = pageNum;
            button.className = 'action-button small';
            button.style.minWidth = '32px';
            button.style.padding = '4px 8px';
            
            if (pageNum === monthlyListCurrentPage) {
                button.style.backgroundColor = 'var(--primary-color)';
                button.style.color = 'white';
                button.disabled = true;
            }
            
            button.onclick = () => goToMonthlyListPage(pageNum);
            pageNumbersContainer.appendChild(button);
        }
        
        function goToMonthlyListPage(pageNum) {
            const totalPages = Math.ceil(monthlyListTotalResults / monthlyListPageSize);
            if (pageNum >= 1 && pageNum <= totalPages) {
                monthlyListCurrentPage = pageNum;
                populateMonthlyListTableWithPagination();
            }
        }
        
        function goToMonthlyListPreviousPage() {
            if (monthlyListCurrentPage > 1) {
                monthlyListCurrentPage--;
                populateMonthlyListTableWithPagination();
            }
        }
        
        function goToMonthlyListNextPage() {
            const totalPages = Math.ceil(monthlyListTotalResults / monthlyListPageSize);
            if (monthlyListCurrentPage < totalPages) {
                monthlyListCurrentPage++;
                populateMonthlyListTableWithPagination();
            }
        }
        
        function changeMonthlyListPageSize() {
            const pageSizeSelect = document.getElementById('monthly-list-page-size');
            if (pageSizeSelect) {
                monthlyListPageSize = parseInt(pageSizeSelect.value);
                monthlyListCurrentPage = 1; // Reset to first page
                populateMonthlyListTableWithPagination();
            }
        }
        
        function filterMonthlyList() {
            console.log('🔍 Filtering Monthly List...');
            loadMonthlyListData();
        }
        
        function viewMonthlyListScorecard(resultId) {
            console.log('👁️ Viewing scorecard result:', resultId);
            
            const results = DB.get('scorecard_results') || [];
            const result = results.find(r => r.id === resultId);
            
            if (!result) {
                alert('Scorecard result not found');
                return;
            }
            
            // Close the monthly list modal first
            const monthlyListModal = document.getElementById('monthly-list-modal');
            if (monthlyListModal) {
                monthlyListModal.style.display = 'none';
            }
            
            // Open the scorecard editor modal with this result
            const scorecards = DB.get('scorecards') || [];
            const scorecard = scorecards.find(sc => sc.id === result.scorecard_id);
            
            if (scorecard) {
                editorScorecard = scorecard;
                editorPeriod = { month: result.period_month, year: result.period_year };
                openEditorModal();
            }
        }
        
        function exportMonthlyListToExcel() {
            console.log('📊 Exporting Monthly List to Excel...');
            
            if (monthlyListFilteredResults.length === 0) {
                alert('No data to export');
                return;
            }
            
            // Create CSV content
            let csvContent = 'Scorecard Name,Department,Score,Status,Date\n';
            
            const scorecards = DB.get('scorecards') || [];
            const months = [
                'January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'
            ];
            
            // Export all filtered results, not just current page
            monthlyListFilteredResults.forEach(result => {
                const scorecard = scorecards.find(sc => sc.id === result.scorecard_id);
                if (!scorecard) return;
                
                const monthName = months[result.period_month - 1] || 'Unknown';
                const statusText = result.status ? result.status.charAt(0).toUpperCase() + result.status.slice(1) : 'Unknown';
                
                const rowData = [
                    scorecard.name,
                    scorecard.department,
                    result.total_score ? result.total_score.toFixed(1) + '%' : 'N/A',
                    statusText,
                    `${monthName} ${result.period_year}`
                ];
                
                // Escape quotes and wrap in quotes if contains comma
                const escapedRowData = rowData.map(cell => {
                    if (cell.includes(',') || cell.includes('"')) {
                        return '"' + cell.replace(/"/g, '""') + '"';
                    }
                    return cell;
                });
                
                csvContent += escapedRowData.join(',') + '\n';
            });
            
            // Create and download file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `monthly_scorecard_list_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            console.log(`✅ Monthly List exported to Excel (${monthlyListFilteredResults.length} records)`);
        }
    </script>
</body>
</html> 
</html> 